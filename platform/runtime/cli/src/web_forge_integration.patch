# Web Forge Enhanced Setup Integration Patch

This patch integrates the enhanced setup flow into main.py. Apply these changes to enable the complete setup wizard flow with proper success/failure handling and transitions.

## Changes to main.py

### 1. Import the enhanced module (add after other imports around line 95):

```python
try:
    from web_forge_enhanced import (
        run_enhanced_setup_wizard, 
        SetupStateManager, 
        SetupLogger,
        transition_to_web_forge_main
    )
    WEB_FORGE_ENHANCED = True
except ImportError:
    WEB_FORGE_ENHANCED = False
```

### 2. Add setup state tracking to MenuState class (around line 115):

```python
class MenuState:
    # ... existing fields ...
    setup_complete = False
    web_forge_ready = False
    web_forge_first_run = False
```

### 3. Replace the run_setup_wizard function (around line 4640):

```python
def run_setup_wizard():
    """Interactive setup wizard with enhanced flow"""
    if WEB_FORGE_ENHANCED:
        # Use enhanced setup wizard
        run_enhanced_setup_wizard()
    else:
        # Fallback to original implementation
        run_setup_wizard_original()

def run_setup_wizard_original():
    # Move the existing run_setup_wizard code here
    # ... existing implementation ...
```

### 4. Update web_forge_menu function to check setup state (around line 4370):

```python
def web_forge_menu():
    """Enhanced web forge with setup state awareness"""
    menu_state.in_submenu = 'web_forge'
    menu_state.web_forge_index = 0
    
    # Check if setup is complete
    if WEB_FORGE_ENHANCED:
        setup_state = SetupStateManager()
        if not setup_state.is_setup_complete() and menu_state.web_forge_first_run:
            # First time and not set up - run wizard automatically
            run_enhanced_setup_wizard()
            return
    
    # Draw web forge menu in main content area
    draw_web_forge_menu()
    # ... rest of the function ...
```

### 5. Update draw_web_forge_menu to show enhanced status (around line 4420):

```python
def draw_web_forge_menu():
    """Enhanced web forge menu with setup status"""
    cols, lines = get_terminal_size()
    content_x = 27  # After sidebar
    content_width = cols - content_x - 1
    content_height = lines - 4
    
    # Clear content area
    for y in range(3, lines - 1):
        move_cursor(content_x, y)
        print(' ' * content_width, end='', flush=True)
    
    # Draw box with medieval style
    draw_box(content_x, 3, content_width - 1, lines - 4, "⚔️  Web Forge  ⚔️", Colors.BLUE)
    
    # Enhanced status check
    if WEB_FORGE_ENHANCED:
        setup_state = SetupStateManager()
        status = setup_state.get_setup_status()
        
        # Show setup status
        move_cursor(content_x + 5, 5)
        if status['complete']:
            print(f"{Colors.GREEN}✓ Environment Ready{Colors.RESET}")
            if menu_state.web_forge_ready:
                # Show quick launch options
                move_cursor(content_x + 5, 6)
                print(f"{Colors.CYAN}Quick Launch: Press 'B' for both servers{Colors.RESET}")
        else:
            print(f"{Colors.YELLOW}⚠ Setup Required - Run Setup Wizard{Colors.RESET}")
    else:
        # Original environment check
        env_status = check_environment_quick()
        # ... existing code ...
```

### 6. Add server status tracking (new function after line 4800):

```python
def get_server_status():
    """Get current server status"""
    status = {
        'backend': {'running': False, 'pid': None, 'url': 'http://localhost:8000'},
        'frontend': {'running': False, 'pid': None, 'url': 'http://localhost:3000'}
    }
    
    # Check backend
    try:
        import requests
        response = requests.get('http://localhost:8000/health/', timeout=1)
        status['backend']['running'] = response.status_code == 200
    except:
        pass
    
    # Check frontend
    try:
        import requests
        response = requests.get('http://localhost:3000', timeout=1)
        status['frontend']['running'] = response.status_code == 200
    except:
        pass
    
    return status
```

### 7. Update start_web_both to use enhanced flow (around line 4900):

```python
def start_web_both():
    """Start both servers with setup check"""
    if WEB_FORGE_ENHANCED:
        setup_state = SetupStateManager()
        if not setup_state.is_setup_complete():
            # Setup not complete
            clear_content_area()
            show_server_action("⚠️ Setup Required", Colors.YELLOW)
            
            cols, lines = get_terminal_size()
            content_x = 27 + 4
            y = 5
            
            move_cursor(content_x, y)
            print(f"{Colors.YELLOW}Setup not complete. Run Setup Wizard first.{Colors.RESET}")
            y += 2
            
            move_cursor(content_x, y)
            print(f"{Colors.CYAN}Run setup now? (y/n): {Colors.RESET}", end='', flush=True)
            
            key = get_single_key()
            if key and key.lower() == 'y':
                run_enhanced_setup_wizard()
            return
    
    # Continue with original implementation
    # ... existing code ...
```

### 8. Add health check endpoints (new section for backend/frontend):

For backend, create `/backend/health/views.py`:
```python
from django.http import JsonResponse

def health_check(request):
    return JsonResponse({
        'status': 'healthy',
        'service': 'unibos-backend',
        'timestamp': datetime.now().isoformat()
    })
```

For frontend, add to `package.json` proxy configuration:
```json
"proxy": "http://localhost:8000"
```

### 9. Add keyboard shortcuts for quick actions in web_forge_menu:

```python
# In handle_web_forge_menu function, add:
elif key in ['b', 'B']:  # Quick start both
    if menu_state.setup_complete:
        start_web_both()
elif key in ['d', 'D']:  # Quick diagnostics
    if WEB_FORGE_ENHANCED:
        logger = SetupLogger()
        run_debug_diagnostics({}, logger)
```

## Testing the Integration

1. **First Run Experience**:
   - Delete `.unibos_setup_state.json` to simulate fresh install
   - Enter Web Forge menu
   - Should automatically prompt for setup

2. **Setup Success Flow**:
   - Run setup wizard
   - On success, should transition to main Web Forge
   - Quick launch options should be available

3. **Setup Failure Recovery**:
   - Simulate failure by removing Node.js from PATH
   - Run setup wizard
   - Should show failure screen with recovery options
   - Debug diagnostics should identify the issue

4. **Persistence Check**:
   - Complete setup successfully
   - Exit and restart unibos
   - Enter Web Forge - should show "Environment Ready"
   - No re-setup required

## Rollback Plan

If issues occur, the original functions are preserved with `_original` suffix, allowing easy rollback by changing function calls.

## Monitoring and Logging

All setup attempts are logged to `/Users/berkhatirli/Desktop/unibos/logs/setup/` with:
- Timestamp
- Success/failure status
- Detailed error messages
- System diagnostics

## Security Considerations

1. No credentials stored in state file
2. Logs sanitized of sensitive information
3. File permissions checked before modifications
4. All subprocess calls use capture_output to prevent injection

This completes the Web Forge enhanced setup integration.