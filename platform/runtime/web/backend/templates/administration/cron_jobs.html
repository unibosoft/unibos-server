{% extends 'administration/base_admin.html' %}

{% block title %}cron jobs - administration - unibos{% endblock %}

{% block admin_content %}
<style>
    .cron-container {
        padding: 20px;
    }
    
    .cron-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--orange);
    }
    
    .cron-title {
        font-size: 24px;
        color: var(--orange);
        font-weight: bold;
        text-transform: lowercase;
    }
    
    .cron-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--dark-gray);
        border-radius: 5px;
        padding: 15px;
    }
    
    .stat-label {
        font-size: 11px;
        color: var(--gray);
        text-transform: lowercase;
        margin-bottom: 5px;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: var(--white);
    }
    
    .stat-value.success { color: var(--green); }
    .stat-value.warning { color: var(--yellow); }
    .stat-value.error { color: #ff4444; }
    
    .attention-section {
        background: rgba(255, 140, 0, 0.05);
        border: 1px solid var(--orange);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 30px;
    }
    
    .attention-title {
        color: var(--orange);
        font-weight: bold;
        margin-bottom: 10px;
        text-transform: lowercase;
    }
    
    .attention-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 140, 0, 0.2);
    }
    
    .attention-item:last-child {
        border-bottom: none;
    }
    
    .jobs-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .jobs-table th {
        background: rgba(255, 140, 0, 0.1);
        color: var(--orange);
        padding: 12px;
        text-align: left;
        font-weight: bold;
        font-size: 12px;
        text-transform: lowercase;
        border-bottom: 2px solid var(--orange);
    }
    
    .jobs-table td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 13px;
    }
    
    .jobs-table tr:hover {
        background: rgba(255, 140, 0, 0.05);
    }
    
    .status-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: bold;
    }
    
    .status-badge.running {
        background: rgba(0, 255, 255, 0.2);
        color: var(--cyan);
    }
    
    .status-badge.success {
        background: rgba(0, 255, 0, 0.2);
        color: var(--green);
    }
    
    .status-badge.failed {
        background: rgba(255, 68, 68, 0.2);
        color: #ff4444;
    }
    
    .status-badge.inactive {
        background: rgba(128, 128, 128, 0.2);
        color: var(--gray);
    }
    
    .toggle-btn {
        padding: 4px 10px;
        border: 1px solid var(--dark-gray);
        background: rgba(255, 255, 255, 0.05);
        color: var(--white);
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
        transition: all 0.2s;
    }
    
    .toggle-btn:hover {
        background: rgba(255, 140, 0, 0.1);
        border-color: var(--orange);
    }
    
    .toggle-btn.active {
        background: rgba(0, 255, 0, 0.1);
        border-color: var(--green);
        color: var(--green);
    }
    
    .action-btns {
        display: flex;
        gap: 5px;
    }
    
    .action-btn {
        padding: 3px 8px;
        border: 1px solid var(--dark-gray);
        background: transparent;
        color: var(--gray);
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
        transition: all 0.2s;
    }
    
    .action-btn:hover {
        color: var(--white);
        border-color: var(--white);
    }
    
    .action-btn.run {
        color: var(--cyan);
        border-color: var(--cyan);
    }
    
    .action-btn.reset {
        color: var(--yellow);
        border-color: var(--yellow);
    }
    
    .schedule-code {
        font-family: 'JetBrains Mono', monospace;
        background: rgba(0, 0, 0, 0.3);
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
    }
    
    .time-ago {
        color: var(--gray);
        font-size: 11px;
    }
    
    .error-count {
        color: #ff4444;
        font-weight: bold;
    }
    
    .sources-section {
        margin-top: 40px;
        padding-top: 30px;
        border-top: 1px solid var(--dark-gray);
    }
    
    .sources-title {
        font-size: 18px;
        color: var(--orange);
        margin-bottom: 20px;
        text-transform: lowercase;
    }
    
    .sources-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }
    
    .source-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--dark-gray);
        border-radius: 5px;
        padding: 15px;
    }
    
    .source-name {
        font-weight: bold;
        color: var(--white);
        margin-bottom: 10px;
    }
    
    .source-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 5px;
        font-size: 11px;
        color: var(--gray);
    }
    
    .source-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    
    .source-status.active { background: var(--green); }
    .source-status.error { background: #ff4444; }
    
    .new-job-btn {
        padding: 8px 16px;
        background: var(--orange);
        color: var(--bg-black);
        border: none;
        border-radius: 3px;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.2s;
    }
    
    .new-job-btn:hover {
        opacity: 0.8;
    }
</style>

<div class="cron-container">
    <div class="cron-header">
        <h1 class="cron-title">‚è∞ cron job management</h1>
        <button class="new-job-btn" onclick="showNewJobModal()">+ new job</button>
    </div>
    
    <!-- Statistics -->
    <div class="cron-stats">
        <div class="stat-card">
            <div class="stat-label">total jobs</div>
            <div class="stat-value">{{ total_jobs }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">active jobs</div>
            <div class="stat-value success">{{ active_jobs }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">failed jobs</div>
            <div class="stat-value error">{{ failed_jobs }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">needs attention</div>
            <div class="stat-value warning">{{ jobs_needing_attention|length }}</div>
        </div>
    </div>
    
    <!-- Jobs Needing Attention -->
    {% if jobs_needing_attention %}
    <div class="attention-section">
        <div class="attention-title">‚ö†Ô∏è jobs needing attention</div>
        {% for item in jobs_needing_attention %}
        <div class="attention-item">
            <span>
                <strong>{{ item.job.name }}</strong> - {{ item.reason }}
            </span>
            <form method="post" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="job_id" value="{{ item.job.id }}">
                <button type="submit" name="action" value="reset_errors" class="action-btn reset">
                    reset errors
                </button>
            </form>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Jobs Table -->
    <table class="jobs-table">
        <thead>
            <tr>
                <th>name</th>
                <th>schedule</th>
                <th>status</th>
                <th>last run</th>
                <th>next run</th>
                <th>runs</th>
                <th>errors</th>
                <th>actions</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr>
                <td>
                    <strong>{{ job.name }}</strong>
                    <div style="color: var(--gray); font-size: 11px;">
                        {{ job.command }}
                    </div>
                </td>
                <td>
                    <span class="schedule-code">{{ job.schedule }}</span>
                </td>
                <td>
                    {% if not job.is_active %}
                        <span class="status-badge inactive">inactive</span>
                    {% elif job.status == 'running' %}
                        <span class="status-badge running">running</span>
                    {% elif job.status == 'success' %}
                        <span class="status-badge success">success</span>
                    {% elif job.status == 'failed' %}
                        <span class="status-badge failed">failed</span>
                    {% else %}
                        <span class="status-badge">{{ job.status|default:"pending" }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if job.last_run %}
                        {{ job.last_run|date:"d.m H:i" }}
                        <div class="time-ago">{{ job.last_run|timesince }} ago</div>
                    {% else %}
                        <span style="color: var(--gray);">never</span>
                    {% endif %}
                </td>
                <td>
                    {% if job.next_run %}
                        {{ job.next_run|date:"d.m H:i" }}
                        <div class="time-ago">in {{ job.next_run|timeuntil }}</div>
                    {% else %}
                        <span style="color: var(--gray);">-</span>
                    {% endif %}
                </td>
                <td>
                    {{ job.run_count }}
                    {% if job.success_count %}
                        <div style="color: var(--green); font-size: 11px;">
                            {{ job.success_count }} ok
                        </div>
                    {% endif %}
                </td>
                <td>
                    {% if job.error_count > 0 %}
                        <span class="error-count">{{ job.error_count }}</span>
                        {% if job.last_error %}
                            <div style="color: var(--gray); font-size: 10px; max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="{{ job.last_error }}">
                                {{ job.last_error|truncatechars:30 }}
                            </div>
                        {% endif %}
                    {% else %}
                        <span style="color: var(--green);">0</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-btns">
                        <form method="post" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="job_id" value="{{ job.id }}">
                            <button type="submit" name="action" value="toggle" 
                                    class="toggle-btn {% if job.is_active %}active{% endif %}">
                                {% if job.is_active %}on{% else %}off{% endif %}
                            </button>
                        </form>
                        
                        <form method="post" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="job_id" value="{{ job.id }}">
                            <button type="submit" name="action" value="run_now" 
                                    class="action-btn run" title="run now">
                                ‚ñ∂
                            </button>
                        </form>
                        
                        {% if job.error_count > 0 %}
                        <form method="post" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="job_id" value="{{ job.id }}">
                            <button type="submit" name="action" value="reset_errors" 
                                    class="action-btn reset" title="reset errors">
                                ‚Üª
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px; color: var(--gray);">
                    no cron jobs configured
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Data Sources Section -->
    {% if data_sources %}
    <div class="sources-section">
        <h2 class="sources-title">üì° earthquake data sources</h2>
        <div class="sources-grid">
            {% for source in data_sources %}
            <div class="source-card">
                <div class="source-name">
                    <span class="source-status {% if source.is_active %}active{% else %}error{% endif %}"></span>
                    {{ source.name }}
                </div>
                <div class="source-info">
                    <span>fetches: {{ source.fetch_count }}</span>
                    <span>errors: {{ source.error_count }}</span>
                </div>
                {% if source.last_fetch %}
                <div class="source-info">
                    <span>last: {{ source.last_fetch|timesince }} ago</span>
                    {% if source.is_active %}
                        <span style="color: var(--green);">active</span>
                    {% else %}
                        <span style="color: var(--gray);">inactive</span>
                    {% endif %}
                </div>
                {% endif %}
                {% if source.last_error %}
                <div style="color: #ff4444; font-size: 10px; margin-top: 5px;">
                    {{ source.last_error|truncatechars:50 }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- New Job Modal (hidden by default) -->
<div id="newJobModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-black); border: 2px solid var(--orange); border-radius: 5px; padding: 30px; min-width: 400px;">
        <h3 style="color: var(--orange); margin-bottom: 20px;">create new cron job</h3>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="create">
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: var(--gray); font-size: 11px; margin-bottom: 5px;">job name</label>
                <input type="text" name="name" required 
                       style="width: 100%; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid var(--dark-gray); color: var(--white);">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: var(--gray); font-size: 11px; margin-bottom: 5px;">command</label>
                <input type="text" name="command" required 
                       style="width: 100%; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid var(--dark-gray); color: var(--white);">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: var(--gray); font-size: 11px; margin-bottom: 5px;">schedule (cron format)</label>
                <select name="schedule" 
                        style="width: 100%; padding: 5px; background: rgba(255,255,255,0.05); border: 1px solid var(--dark-gray); color: var(--white);">
                    {% for cron, desc in schedule_examples %}
                    <option value="{{ cron }}">{{ cron }} - {{ desc }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="hideNewJobModal()" 
                        style="padding: 5px 15px; background: transparent; border: 1px solid var(--dark-gray); color: var(--gray); cursor: pointer;">
                    cancel
                </button>
                <button type="submit" 
                        style="padding: 5px 15px; background: var(--orange); border: none; color: var(--bg-black); font-weight: bold; cursor: pointer;">
                    create
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showNewJobModal() {
    document.getElementById('newJobModal').style.display = 'block';
}

function hideNewJobModal() {
    document.getElementById('newJobModal').style.display = 'none';
}

// Auto-refresh every minute
setTimeout(function() {
    location.reload();
}, 60000);
</script>
{% endblock %}