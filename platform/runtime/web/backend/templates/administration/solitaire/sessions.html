{% extends 'administration/base_admin.html' %}

{% block admin_content %}
<div class="section">
    <!-- Section Header -->
    <div class="section-header">
        <h2>ðŸŽ¯ game sessions</h2>
        <div class="section-controls">
            <a href="{% url 'administration:solitaire_dashboard' %}" class="btn-secondary">back to dashboard</a>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="content-box">
        <form method="get" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; margin: 0; min-width: 200px;">
                <label class="form-label">search</label>
                <input type="text" name="search" value="{{ request.GET.search }}" class="form-input" placeholder="session id, ip address...">
            </div>
            <div class="form-group" style="margin: 0;">
                <label class="form-label">status</label>
                <select name="status" class="form-select">
                    <option value="">all</option>
                    <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>in progress</option>
                    <option value="won" {% if request.GET.status == 'won' %}selected{% endif %}>won</option>
                    <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>completed</option>
                    <option value="abandoned" {% if request.GET.status == 'abandoned' %}selected{% endif %}>abandoned</option>
                </select>
            </div>
            <div class="form-group" style="margin: 0;">
                <label class="form-label">from date</label>
                <input type="date" name="date_from" value="{{ request.GET.date_from }}" class="form-input">
            </div>
            <div class="form-group" style="margin: 0;">
                <label class="form-label">to date</label>
                <input type="date" name="date_to" value="{{ request.GET.date_to }}" class="form-input">
            </div>
            <button type="submit" class="btn-primary">filter</button>
            {% if request.GET.search or request.GET.status or request.GET.date_from or request.GET.date_to %}
            <a href="{% url 'administration:solitaire_sessions' %}" class="btn-secondary">clear</a>
            {% endif %}
        </form>
    </div>
    
    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ total_sessions }}</div>
            <div class="stat-label">total sessions</div>
        </div>
        <div class="stat-card">
            <div class="stat-value positive">{{ won_sessions }}</div>
            <div class="stat-label">games won</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ win_rate }}%</div>
            <div class="stat-label">win rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-value negative">{{ abandoned_sessions }}</div>
            <div class="stat-label">abandoned</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ avg_score|floatformat:0 }}</div>
            <div class="stat-label">avg score</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ avg_time }}m</div>
            <div class="stat-label">avg time</div>
        </div>
    </div>
</div>

<!-- Sessions Table -->
<div class="section">
    <div class="content-box">
        <table class="data-table">
            <thead>
                <tr>
                    <th>session id</th>
                    <th>player</th>
                    <th>ip address</th>
                    <th>started</th>
                    <th>ended</th>
                    <th>duration</th>
                    <th>moves</th>
                    <th>score</th>
                    <th>status</th>
                    <th>actions</th>
                </tr>
            </thead>
            <tbody>
                {% for session in sessions %}
                <tr>
                    <td style="font-family: monospace; font-size: 11px;">{{ session.session_id|truncatechars:12 }}</td>
                    <td>
                        {% if session.player.user %}
                            <span class="badge badge-user">{{ session.player.user.username }}</span>
                        {% else %}
                            <span class="badge badge-inactive">{{ session.player.display_name|default:"anonymous" }}</span>
                        {% endif %}
                    </td>
                    <td>{{ session.player.ip_address }}</td>
                    <td>{{ session.started_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        {% if session.ended_at %}
                            {{ session.ended_at|date:"H:i" }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if session.time_played %}
                            {{ session.time_played|floatformat:0 }}s
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ session.moves_count }}</td>
                    <td>
                        {% if session.score > 0 %}
                            <strong>{{ session.score }}</strong>
                        {% else %}
                            {{ session.score }}
                        {% endif %}
                    </td>
                    <td>
                        {% if session.is_won %}
                            <span class="badge badge-approved">won</span>
                        {% elif session.is_abandoned %}
                            <span class="badge badge-rejected">abandoned</span>
                        {% elif session.is_completed %}
                            <span class="badge badge-inactive">lost</span>
                        {% else %}
                            <span class="badge badge-pending">in progress</span>
                        {% endif %}
                    </td>
                    <td class="actions">
                        <a href="#" class="action-link">view</a>
                        {% if not session.is_completed and not session.is_abandoned %}
                            <a href="#" class="action-link" onclick="return confirm('end this session?')">end</a>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center text-muted">no sessions found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Pagination -->
        {% if sessions.has_other_pages %}
        <div style="margin-top: 20px; text-align: center;">
            {% if sessions.has_previous %}
                <a href="?page={{ sessions.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}" class="btn-secondary">previous</a>
            {% endif %}
            
            <span style="margin: 0 15px; color: var(--gray);">
                page {{ sessions.number }} of {{ sessions.paginator.num_pages }}
            </span>
            
            {% if sessions.has_next %}
                <a href="?page={{ sessions.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}" class="btn-secondary">next</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}