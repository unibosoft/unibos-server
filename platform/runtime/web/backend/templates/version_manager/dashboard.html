{% extends 'web_ui/base.html' %}
{% load static %}

{% block title %}version manager - unibos{% endblock %}

{% block header_title %}unibos{% endblock %}
{% block module_name %}version manager{% endblock %}

{% block content %}
<style>
    .version-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .stat-card {
        background: var(--bg-dark);
        border: 1px solid var(--dark-gray);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: var(--cyan);
    }
    
    .stat-label {
        color: var(--gray);
        font-size: 14px;
        text-transform: lowercase;
        letter-spacing: 1px;
        margin-top: 5px;
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        margin: 30px 0;
    }
    
    .action-btn {
        padding: 12px 24px;
        background: var(--orange);
        color: var(--bg-black);
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .action-btn:hover {
        background: var(--orange-bright);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 140, 0, 0.3);
    }
    
    .action-btn.secondary {
        background: var(--dark-gray);
        color: var(--white);
    }
    
    .action-btn.secondary:hover {
        background: var(--gray);
    }
    
    .archives-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .archives-table th {
        background: var(--dark-gray);
        color: var(--orange);
        padding: 12px;
        text-align: left;
        font-weight: bold;
        text-transform: lowercase;
        letter-spacing: 1px;
        font-size: 12px;
    }
    
    .archives-table td {
        padding: 12px;
        border-bottom: 1px solid var(--dark-gray);
        color: var(--white);
    }
    
    .archives-table tr:hover {
        background: rgba(255, 140, 0, 0.1);
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .status-normal {
        background: rgba(0, 255, 0, 0.2);
        color: var(--green);
    }
    
    .status-large {
        background: rgba(255, 255, 0, 0.2);
        color: var(--yellow);
    }
    
    .status-very-large {
        background: rgba(255, 140, 0, 0.2);
        color: var(--orange);
    }
    
    .status-huge {
        background: rgba(255, 0, 0, 0.2);
        color: #ff4444;
    }
    
    .git-status {
        background: var(--bg-dark);
        border: 1px solid var(--dark-gray);
        border-radius: 8px;
        padding: 20px;
        margin-top: 30px;
    }
    
    .git-branch {
        color: var(--green);
        font-weight: bold;
    }
    
    .git-clean {
        color: var(--green);
    }
    
    .git-dirty {
        color: var(--yellow);
    }
    
    .scan-info {
        background: rgba(0, 255, 255, 0.1);
        border: 1px solid var(--cyan);
        border-radius: 5px;
        padding: 15px;
        margin: 20px 0;
        color: var(--cyan);
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid var(--cyan);
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

<!-- Statistics Cards -->
<div class="row">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ total_archives }}</div>
            <div class="stat-label">total archives</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ total_size_gb|floatformat:2 }} GB</div>
            <div class="stat-label">total size</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ average_size_mb|floatformat:1 }} MB</div>
            <div class="stat-label">average size</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ anomaly_count }}</div>
            <div class="stat-label">anomalies</div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="action-buttons">
    <a href="{% url 'version_manager:analyzer' %}" class="action-btn">
        ğŸ“Š archive analyzer
    </a>
    <a href="{% url 'version_manager:anomaly_detection' %}" class="action-btn secondary">
        ğŸ” anomaly detection
    </a>
    <a href="{% url 'version_manager:scan_history' %}" class="action-btn secondary">
        ğŸ“œ scan history
    </a>
    <a href="{% url 'version_manager:archive_operations' %}" class="action-btn secondary">
        ğŸ”§ archive operations
    </a>
    <button class="action-btn secondary" onclick="checkGitStatus()">
        ğŸ“ˆ git status
    </button>
    <button class="action-btn secondary" onclick="startScan()">
        ğŸ” scan archives
    </button>
</div>

<!-- Scan Status -->
{% if latest_scan %}
<div class="scan-info">
    <strong>last scan:</strong> {{ latest_scan.started_at|date:"Y-m-d H:i" }}
    | <strong>duration:</strong> {{ latest_scan.duration_formatted }}
    | <strong>status:</strong> {{ latest_scan.status_message }}
</div>
{% endif %}

<!-- Git Status Section -->
<div class="git-status" id="git-status">
    <h3>ğŸ“ˆ git status</h3>
    <div id="git-content">
        {% if latest_git %}
        <p>
            <strong>branch:</strong> <span class="git-branch">{{ latest_git.branch }}</span>
            | <strong>commit:</strong> {{ latest_git.commit_hash|slice:":8" }}
            | <strong>status:</strong> 
            <span class="{% if latest_git.has_changes %}git-dirty{% else %}git-clean{% endif %}">
                {{ latest_git.get_status_summary }}
            </span>
        </p>
        {% else %}
        <p>click "git status" to check repository status</p>
        {% endif %}
    </div>
</div>

<!-- Archives Table -->
<div class="content-box">
    <h3>recent version archives</h3>
    
    {% if archives %}
    <table class="archives-table" id="archives-table">
        <thead>
            <tr>
                <th class="sortable" data-sort="version">version <span class="sort-arrow">â†•</span></th>
                <th class="sortable" data-sort="build">build <span class="sort-arrow">â†•</span></th>
                <th class="sortable" data-sort="size">size (mb) <span class="sort-arrow">â†•</span></th>
                <th class="sortable" data-sort="files">files <span class="sort-arrow">â†•</span></th>
                <th class="sortable" data-sort="status">status <span class="sort-arrow">â†•</span></th>
                <th class="sortable" data-sort="zscore">z-score <span class="sort-arrow">â†•</span></th>
                <th class="sortable" data-sort="scanned">last scanned <span class="sort-arrow">â†•</span></th>
            </tr>
        </thead>
        <tbody>
            {% for archive in archives %}
            <tr>
                <td><strong>v{{ archive.version }}</strong></td>
                <td style="color: var(--gray); font-size: 12px;">{{ archive.build|default:"â€”" }}</td>
                <td>{{ archive.size_mb|floatformat:2 }}</td>
                <td>{{ archive.file_count }}</td>
                <td>
                    <span class="status-badge status-{{ archive.status }}">
                        {{ archive.get_status_icon }} {{ archive.get_status_display }}
                    </span>
                </td>
                <td>
                    {% if archive.z_score %}
                        {{ archive.z_score|floatformat:2 }}
                        {% if archive.is_anomaly %}
                            <span style="color: #ff4444;">âš ï¸</span>
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>{{ archive.last_scanned|date:"Y-m-d H:i" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: var(--gray); margin: 20px 0;">
        no archives found. click "scan archives" to analyze version directories.
    </p>
    {% endif %}
</div>

<!-- Enhanced Progress Modal with Terminal Output -->
<div id="scan-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-black); border: 2px solid var(--orange); border-radius: 10px; padding: 20px; width: 80%; max-width: 900px; height: 70%; max-height: 600px; display: flex; flex-direction: column;">
        <h3 style="color: var(--orange); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
            <span>ğŸ“Š scanning archives...</span>
            <button onclick="closeScanModal()" style="background: none; border: none; color: var(--gray); cursor: pointer; font-size: 20px;">âœ•</button>
        </h3>
        
        <!-- Progress Bar -->
        <div style="margin-bottom: 15px;">
            <div style="background: var(--dark-gray); height: 25px; border-radius: 12px; overflow: hidden; position: relative;">
                <div id="progress-bar" style="background: linear-gradient(90deg, var(--orange), var(--cyan)); height: 100%; width: 0%; transition: width 0.3s;"></div>
                <span id="progress-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--white); font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">0%</span>
            </div>
        </div>
        
        <!-- Status Info -->
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: rgba(255, 140, 0, 0.1); border-radius: 5px;">
            <div>
                <span style="color: var(--gray);">status:</span>
                <span id="scan-status" style="color: var(--cyan); font-weight: bold; margin-left: 10px;">initializing...</span>
            </div>
            <div>
                <span style="color: var(--gray);">processing:</span>
                <span id="scan-current" style="color: var(--green); font-weight: bold; margin-left: 10px;">-</span>
            </div>
            <div>
                <span style="color: var(--gray);">found:</span>
                <span id="scan-found" style="color: var(--yellow); font-weight: bold; margin-left: 10px;">0 archives</span>
            </div>
        </div>
        
        <!-- Terminal Output -->
        <div style="flex: 1; background: #0a0a0a; border: 1px solid var(--dark-gray); border-radius: 5px; padding: 10px; overflow-y: auto; font-family: 'JetBrains Mono', 'Courier New', monospace; font-size: 12px;">
            <div id="terminal-output" style="color: var(--green); white-space: pre-wrap; line-height: 1.5;">
                <span style="color: var(--cyan);">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—</span>
                <span style="color: var(--cyan);">â•‘         unibos archive scanner v1.0 - terminal output         â•‘</span>
                <span style="color: var(--cyan);">â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
                
                <span style="color: var(--orange);">[system]</span> initializing archive scanner...
                <span style="color: var(--orange);">[system]</span> checking archive directories...
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
            <button id="pause-btn" onclick="togglePauseScan()" style="padding: 8px 16px; background: var(--dark-gray); color: var(--white); border: none; border-radius: 5px; cursor: pointer;">â¸ pause</button>
            <button id="stop-btn" onclick="stopScan()" style="padding: 8px 16px; background: #ff4444; color: var(--white); border: none; border-radius: 5px; cursor: pointer;">â¹ stop</button>
        </div>
    </div>
</div>

<script>
let scanSessionId = null;
let scanInterval = null;
let isPaused = false;
let lastLogIndex = 0;
let archivesFound = 0;

function startScan() {
    // Reset state
    lastLogIndex = 0;
    archivesFound = 0;
    isPaused = false;
    
    // Show modal and reset UI
    document.getElementById('scan-modal').style.display = 'block';
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-text').textContent = '0%';
    document.getElementById('scan-status').textContent = 'initializing...';
    document.getElementById('scan-current').textContent = '-';
    document.getElementById('scan-found').textContent = '0 archives';
    
    // Clear terminal output but keep header
    const terminal = document.getElementById('terminal-output');
    terminal.innerHTML = `<span style="color: var(--cyan);">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—</span>
<span style="color: var(--cyan);">â•‘         unibos archive scanner v1.0 - terminal output         â•‘</span>
<span style="color: var(--cyan);">â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>

`;
    
    addTerminalLine('[system]', 'initializing archive scanner...', 'orange');
    addTerminalLine('[system]', 'connecting to file system...', 'orange');
    
    // Start scan via AJAX
    fetch('{% url "version_manager:start_scan" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            scanSessionId = data.session_id;
            addTerminalLine('[success]', `scan session started: ${scanSessionId}`, 'green');
            addTerminalLine('[info]', 'beginning archive directory scan...', 'cyan');
            // Start polling for progress with faster interval for real-time updates
            scanInterval = setInterval(checkScanProgress, 500);
        } else {
            addTerminalLine('[error]', 'failed to start scan: ' + (data.error || 'unknown error'), 'red');
            setTimeout(() => {
                document.getElementById('scan-modal').style.display = 'none';
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        addTerminalLine('[error]', 'network error: ' + error.message, 'red');
        setTimeout(() => {
            document.getElementById('scan-modal').style.display = 'none';
        }, 3000);
    });
}

function checkScanProgress() {
    if (!scanSessionId || isPaused) return;
    
    fetch(`{% url "version_manager:scan_progress" 0 %}`.replace('0', scanSessionId))
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update progress bar and percentage
            const progress = Math.round(data.progress || 0);
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').textContent = progress + '%';
            
            // Update status
            document.getElementById('scan-status').textContent = data.status_message || 'Processing...';
            
            // Update current archive being processed
            if (data.current_archive) {
                document.getElementById('scan-current').textContent = data.current_archive;
                
                // Add detailed log for current archive
                if (data.current_size) {
                    addTerminalLine('[scan]', `processing: ${data.current_archive}`, 'yellow');
                    addTerminalLine('[size]', `  â†’ size: ${formatBytes(data.current_size)}`, 'gray');
                    if (data.current_files) {
                        addTerminalLine('[files]', `  â†’ files: ${data.current_files}`, 'gray');
                    }
                }
            }
            
            // Update archives found count
            if (data.archives_found !== undefined) {
                archivesFound = data.archives_found;
                document.getElementById('scan-found').textContent = `${archivesFound} archives`;
            }
            
            // Process new log entries
            if (data.logs && data.logs.length > 0) {
                data.logs.forEach(log => {
                    if (log.index > lastLogIndex) {
                        addTerminalLogEntry(log);
                        lastLogIndex = log.index;
                    }
                });
            }
            
            // Check for anomalies
            if (data.anomaly_detected) {
                addTerminalLine('[anomaly]', `âš ï¸ size anomaly detected in ${data.anomaly_archive}`, 'red');
                addTerminalLine('[detail]', `  z-score: ${data.anomaly_zscore?.toFixed(2)}`, 'orange');
            }
            
            // Check if complete
            if (data.is_complete) {
                clearInterval(scanInterval);
                scanInterval = null;
                
                if (data.has_errors) {
                    document.getElementById('scan-status').textContent = 'failed';
                    addTerminalLine('[error]', 'scan failed: ' + data.error_message, 'red');
                } else {
                    document.getElementById('scan-status').textContent = 'complete!';
                    addTerminalLine('[success]', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'green');
                    addTerminalLine('[success]', `scan completed successfully!`, 'green');
                    addTerminalLine('[stats]', `total archives scanned: ${archivesFound}`, 'cyan');
                    if (data.total_size) {
                        addTerminalLine('[stats]', `total size: ${formatBytes(data.total_size)}`, 'cyan');
                    }
                    if (data.anomalies_count) {
                        addTerminalLine('[stats]', `anomalies detected: ${data.anomalies_count}`, 'yellow');
                    }
                    addTerminalLine('[success]', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'green');
                }
                
                // Reload page after delay
                setTimeout(() => {
                    location.reload();
                }, 3000);
            }
        }
    })
    .catch(error => {
        console.error('Error checking progress:', error);
        addTerminalLine('[warning]', 'failed to get progress update', 'orange');
    });
}

function addTerminalLine(prefix, message, color = 'white') {
    const terminal = document.getElementById('terminal-output');
    const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
    
    const colorMap = {
        'orange': '#ff8c00',
        'green': '#00ff00',
        'cyan': '#00ffff',
        'yellow': '#ffff00',
        'red': '#ff4444',
        'gray': '#808080',
        'white': '#ffffff'
    };
    
    const line = document.createElement('div');
    line.innerHTML = `<span style="color: #606060;">[${timestamp}]</span> <span style="color: ${colorMap[color] || color};">${prefix}</span> ${message}`;
    terminal.appendChild(line);
    
    // Auto-scroll to bottom
    terminal.parentElement.scrollTop = terminal.parentElement.scrollHeight;
}

function addTerminalLogEntry(log) {
    const typeColors = {
        'info': 'cyan',
        'success': 'green',
        'warning': 'yellow',
        'error': 'red',
        'debug': 'gray'
    };
    
    const color = typeColors[log.type] || 'white';
    addTerminalLine(`[${log.type || 'log'}]`, log.message, color);
}

function formatBytes(bytes) {
    if (!bytes) return '0 B';
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
}

function togglePauseScan() {
    isPaused = !isPaused;
    const btn = document.getElementById('pause-btn');
    
    if (isPaused) {
        btn.textContent = 'â–¶ resume';
        btn.style.background = 'var(--green)';
        addTerminalLine('[system]', 'scan paused by user', 'yellow');
    } else {
        btn.textContent = 'â¸ pause';
        btn.style.background = 'var(--dark-gray)';
        addTerminalLine('[system]', 'scan resumed', 'green');
    }
}

function stopScan() {
    if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
    }
    
    if (scanSessionId) {
        // Send stop request
        fetch(`{% url "version_manager:stop_scan" 0 %}`.replace('0', scanSessionId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        });
        
        addTerminalLine('[system]', 'scan stopped by user', 'orange');
    }
    
    setTimeout(() => {
        document.getElementById('scan-modal').style.display = 'none';
        location.reload();
    }, 1500);
}

function closeScanModal() {
    if (scanInterval) {
        if (confirm('scan is still running. are you sure you want to close?')) {
            stopScan();
        }
    } else {
        document.getElementById('scan-modal').style.display = 'none';
    }
}

function checkGitStatus() {
    const gitContent = document.getElementById('git-content');
    gitContent.innerHTML = '<span class="loading-spinner"></span> checking git status...';
    
    fetch('{% url "version_manager:git_status" %}')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const statusClass = data.has_changes ? 'git-dirty' : 'git-clean';
            gitContent.innerHTML = `
                <p>
                    <strong>branch:</strong> <span class="git-branch">${data.branch}</span>
                    | <strong>commit:</strong> ${data.commit}
                    | <strong>author:</strong> ${data.author}
                </p>
                <p>
                    <strong>status:</strong> 
                    <span class="${statusClass}">${data.summary}</span>
                </p>
                ${data.has_changes ? `
                    <p style="color: var(--gray); font-size: 12px;">
                        modified: ${data.modified} | untracked: ${data.untracked} | staged: ${data.staged}
                    </p>
                ` : ''}
            `;
        } else {
            gitContent.innerHTML = '<p style="color: #ff4444;">error: ' + data.error + '</p>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        gitContent.innerHTML = '<p style="color: #ff4444;">failed to check git status</p>';
    });
}

// Auto-refresh git status every 30 seconds
setInterval(checkGitStatus, 30000);
</script>

{% endblock %}