{% extends "web_ui/base.html" %}
{% load static %}

{% block title %}{{ camera.name }} - unibos cctv{% endblock %}

{% block header_title %}unibos{% endblock %}
{% block module_name %}cctv - {{ camera.name }}{% endblock %}

{% block extra_css %}
<style>
    .camera-detail-container {
        padding: 20px;
        background: #0a0a0a;
        min-height: calc(100vh - 120px);
    }
    
    .camera-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #333;
    }
    
    .camera-title {
        font-size: 1.5em;
        color: #ff8c00;
        text-transform: lowercase;
    }
    
    .camera-status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.9em;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-online {
        background: rgba(0, 255, 0, 0.2);
        color: #00ff00;
        border: 1px solid #00ff00;
    }
    
    .status-offline {
        background: rgba(255, 0, 0, 0.2);
        color: #ff0000;
        border: 1px solid #ff0000;
    }
    
    .status-recording {
        background: rgba(255, 0, 0, 0.2);
        color: #ff0000;
        border: 1px solid #ff0000;
        animation: pulse 1.5s infinite;
    }
    
    .main-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
    }
    
    @media (max-width: 1200px) {
        .main-content {
            grid-template-columns: 1fr;
        }
    }
    
    .video-section {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .video-player {
        position: relative;
        aspect-ratio: 16/9;
        background: #000;
    }
    
    .video-player img, .video-player video {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    
    .video-controls {
        display: flex;
        gap: 10px;
        padding: 15px;
        background: #222;
        border-top: 1px solid #333;
    }
    
    .control-btn {
        flex: 1;
        padding: 10px;
        background: #333;
        border: 1px solid #444;
        color: #ff8c00;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: lowercase;
    }
    
    .control-btn:hover {
        background: #ff8c00;
        color: #000;
        border-color: #ff8c00;
    }
    
    .control-btn.active {
        background: #ff8c00;
        color: #000;
        border-color: #ff8c00;
    }
    
    .info-panel {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .info-card {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px;
    }
    
    .info-card h3 {
        color: #ff8c00;
        font-size: 1.1em;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #333;
        text-transform: lowercase;
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #222;
    }
    
    .info-row:last-child {
        border-bottom: none;
    }
    
    .info-label {
        color: #888;
        font-size: 0.9em;
    }
    
    .info-value {
        color: #fff;
        font-weight: bold;
    }
    
    .ptz-controller {
        display: grid;
        grid-template-columns: repeat(3, 60px);
        grid-template-rows: repeat(3, 60px);
        gap: 5px;
        justify-content: center;
        margin: 20px 0;
    }
    
    .ptz-btn {
        background: #222;
        border: 1px solid #444;
        color: #ff8c00;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.5em;
        transition: all 0.2s ease;
    }
    
    .ptz-btn:hover {
        background: #ff8c00;
        color: #000;
        border-color: #ff8c00;
    }
    
    .ptz-btn:active {
        transform: scale(0.95);
    }
    
    .ptz-btn:nth-child(2) { grid-column: 2; }
    .ptz-btn:nth-child(4) { grid-column: 1; grid-row: 2; }
    .ptz-btn:nth-child(5) { grid-column: 2; grid-row: 2; }
    .ptz-btn:nth-child(6) { grid-column: 3; grid-row: 2; }
    .ptz-btn:nth-child(8) { grid-column: 2; grid-row: 3; }
    
    .zoom-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 10px;
    }
    
    .recordings-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .recording-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #222;
        border-radius: 4px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .recording-item:hover {
        background: #2a2a2a;
        border-left: 3px solid #ff8c00;
    }
    
    .recording-info {
        flex: 1;
    }
    
    .recording-time {
        color: #ff8c00;
        font-size: 0.9em;
        margin-bottom: 3px;
    }
    
    .recording-duration {
        color: #888;
        font-size: 0.8em;
    }
    
    .alert-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background: #222;
        border-radius: 4px;
        margin-bottom: 8px;
        border-left: 3px solid #444;
    }
    
    .alert-item.priority-high {
        border-left-color: #ff0000;
    }
    
    .alert-item.priority-medium {
        border-left-color: #ff8c00;
    }
    
    .alert-icon {
        font-size: 1.5em;
        margin-right: 10px;
    }
    
    .alert-content {
        flex: 1;
    }
    
    .alert-type {
        color: #ff8c00;
        font-weight: bold;
        margin-bottom: 3px;
    }
    
    .alert-time {
        color: #666;
        font-size: 0.8em;
    }
    
    .stream-quality-selector {
        display: flex;
        gap: 5px;
        padding: 10px;
        background: #222;
        border-bottom: 1px solid #333;
    }
    
    .quality-btn {
        padding: 5px 10px;
        background: #333;
        border: 1px solid #444;
        color: #888;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s ease;
    }
    
    .quality-btn.active {
        background: #ff8c00;
        color: #000;
        border-color: #ff8c00;
    }
    
    .quality-btn:hover:not(.active) {
        border-color: #ff8c00;
        color: #ff8c00;
    }
</style>
{% endblock %}

{% block content %}
<div class="camera-detail-container">
    <!-- Header -->
    <div class="camera-header">
        <div>
            <h1 class="camera-title">üìπ {{ camera.name }}</h1>
            <div style="color: #888; margin-top: 5px;">{{ camera.location }}</div>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <span class="camera-status-badge status-{{ camera.status }}">
                {% if camera.status == 'recording' %}‚¨§ {% endif %}{{ camera.status }}
            </span>
            <a href="{% url 'cctv:camera_grid' %}" style="color: #888; text-decoration: none;">‚Üê back to grid</a>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Video Section -->
        <div class="video-section">
            {% if streams %}
            <div class="stream-quality-selector">
                <span style="color: #888; margin-right: 10px;">quality:</span>
                {% for stream in streams %}
                <button class="quality-btn {% if stream.quality == 'main' %}active{% endif %}" 
                        onclick="changeStreamQuality('{{ stream.quality }}')">
                    {{ stream.quality }}
                </button>
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="video-player">
                <img id="camera-stream" 
                     src="{% url 'cctv:stream_proxy' camera.id %}"
                     alt="{{ camera.name }} stream"
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iODAwIiBoZWlnaHQ9IjQ1MCIgZmlsbD0iIzFhMWExYSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSIjNjY2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIyNCI+bm8gc2lnbmFsPC90ZXh0Pjwvc3ZnPg==';">
            </div>
            
            <div class="video-controls">
                {% if camera.status == 'online' %}
                <button class="control-btn" onclick="startRecording()">‚¨§ start recording</button>
                {% elif camera.status == 'recording' %}
                <button class="control-btn active" onclick="stopRecording()">‚óº stop recording</button>
                {% endif %}
                <button class="control-btn" onclick="takeSnapshot()">üì∏ snapshot</button>
                <button class="control-btn" onclick="toggleFullscreen()">‚õ∂ fullscreen</button>
                {% if camera.audio_enabled %}
                <button class="control-btn" id="audio-btn" onclick="toggleAudio()">üîá audio</button>
                {% endif %}
            </div>
        </div>
        
        <!-- Info Panel -->
        <div class="info-panel">
            <!-- Camera Info -->
            <div class="info-card">
                <h3>üìπ camera information</h3>
                <div class="info-row">
                    <span class="info-label">model:</span>
                    <span class="info-value">{{ camera.get_model_display }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ip address:</span>
                    <span class="info-value">{{ camera.ip_address }}:{{ camera.port }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">resolution:</span>
                    <span class="info-value">{{ camera.resolution }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">fps:</span>
                    <span class="info-value">{{ camera.fps }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">motion detection:</span>
                    <span class="info-value">{% if camera.motion_detection %}enabled{% else %}disabled{% endif %}</span>
                </div>
                {% if camera.last_seen %}
                <div class="info-row">
                    <span class="info-label">last seen:</span>
                    <span class="info-value">{{ camera.last_seen|timesince }} ago</span>
                </div>
                {% endif %}
            </div>
            
            <!-- PTZ Controls -->
            {% if camera.has_ptz %}
            <div class="info-card">
                <h3>üéÆ ptz controls</h3>
                <div class="ptz-controller">
                    <div></div>
                    <button class="ptz-btn" onclick="ptzControl('up')">‚Üë</button>
                    <div></div>
                    <button class="ptz-btn" onclick="ptzControl('left')">‚Üê</button>
                    <button class="ptz-btn" onclick="ptzControl('home')">‚åÇ</button>
                    <button class="ptz-btn" onclick="ptzControl('right')">‚Üí</button>
                    <div></div>
                    <button class="ptz-btn" onclick="ptzControl('down')">‚Üì</button>
                    <div></div>
                </div>
                <div class="zoom-controls">
                    <button class="control-btn" onclick="ptzControl('zoom_in')">üîç zoom in</button>
                    <button class="control-btn" onclick="ptzControl('zoom_out')">üîç zoom out</button>
                </div>
            </div>
            {% endif %}
            
            <!-- Recent Recordings -->
            {% if recent_recordings %}
            <div class="info-card">
                <h3>üé¨ recent recordings</h3>
                <div class="recordings-list">
                    {% for recording in recent_recordings %}
                    <div class="recording-item" onclick="viewRecording('{{ recording.id }}')">
                        <div class="recording-info">
                            <div class="recording-time">{{ recording.start_time|date:"d/m H:i" }}</div>
                            <div class="recording-duration">
                                {% if recording.duration %}{{ recording.duration }}s{% else %}in progress{% endif %}
                            </div>
                        </div>
                        <span style="color: #ff8c00;">‚ñ∂</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Recent Alerts -->
            {% if recent_alerts %}
            <div class="info-card">
                <h3>üö® recent alerts</h3>
                <div style="max-height: 300px; overflow-y: auto;">
                    {% for alert in recent_alerts %}
                    <div class="alert-item priority-{{ alert.priority }}">
                        <div class="alert-icon">
                            {% if alert.alert_type == 'motion' %}üèÉ
                            {% elif alert.alert_type == 'person' %}üë§
                            {% elif alert.alert_type == 'vehicle' %}üöó
                            {% else %}‚ö†Ô∏è
                            {% endif %}
                        </div>
                        <div class="alert-content">
                            <div class="alert-type">{{ alert.get_alert_type_display }}</div>
                            <div class="alert-time">{{ alert.timestamp|timesince }} ago</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
const cameraId = '{{ camera.id }}';
let audioEnabled = false;

function startRecording() {
    fetch(`/cctv/record/start/${cameraId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to start recording: ' + data.error);
        }
    });
}

function stopRecording() {
    fetch(`/cctv/record/stop/${cameraId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to stop recording: ' + data.error);
        }
    });
}

function takeSnapshot() {
    window.open(`/cctv/snapshot/${cameraId}/`, '_blank');
}

function toggleFullscreen() {
    const videoPlayer = document.querySelector('.video-player');
    if (!document.fullscreenElement) {
        videoPlayer.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

function toggleAudio() {
    audioEnabled = !audioEnabled;
    const audioBtn = document.getElementById('audio-btn');
    if (audioEnabled) {
        audioBtn.textContent = 'üîä audio';
        audioBtn.classList.add('active');
    } else {
        audioBtn.textContent = 'üîá audio';
        audioBtn.classList.remove('active');
    }
}

function ptzControl(command) {
    fetch(`/cctv/api/ptz/${cameraId}/?command=${command}`)
        .then(response => response.json())
        .then(data => {
            console.log('PTZ command sent:', data);
        });
}

function changeStreamQuality(quality) {
    // Update quality buttons
    document.querySelectorAll('.quality-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.trim() === quality) {
            btn.classList.add('active');
        }
    });
    
    // Reload stream with new quality
    const streamImg = document.getElementById('camera-stream');
    streamImg.src = `/cctv/stream/${cameraId}/?quality=${quality}`;
}

function viewRecording(recordingId) {
    window.location.href = `/cctv/playback/${recordingId}/`;
}

// Auto-refresh stream every 60 seconds
setInterval(() => {
    const streamImg = document.getElementById('camera-stream');
    const src = streamImg.src;
    streamImg.src = '';
    streamImg.src = src;
}, 60000);

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.key === 'f' || e.key === 'F') {
        toggleFullscreen();
    } else if (e.key === ' ') {
        e.preventDefault();
        if ('{{ camera.status }}' === 'online') {
            startRecording();
        } else if ('{{ camera.status }}' === 'recording') {
            stopRecording();
        }
    }
});
</script>
{% endblock %}