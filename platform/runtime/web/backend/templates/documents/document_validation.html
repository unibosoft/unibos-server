{% extends 'web_ui/base.html' %}

{% block title %}community validation - earn carrots ü•ï{% endblock %}

{% block header_title %}unibos{% endblock %}
{% block module_name %}documents{% endblock %}

{% block extra_head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<style>
    /* Reset base styles that might interfere */
    .content {
        max-width: none !important;
        width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    .validation-container {
        width: 100%;
        padding: 15px;
        box-sizing: border-box;
        overflow-x: hidden;
    }
    
    .validation-header {
        background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
        border: 2px solid var(--orange);
        border-radius: 10px;
        padding: 30px;
        margin-bottom: 30px;
        position: relative;
        overflow: visible;
    }
    
    .carrot-counter {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255,140,0,0.2);
        border: 2px solid var(--orange);
        border-radius: 20px;
        padding: 10px 20px;
        font-size: 24px;
        font-weight: bold;
        color: var(--orange);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    /* 2-column layout without stats */
    .validation-grid {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 20px;
        margin-top: 20px;
        height: calc(100vh - 250px);
        min-height: 600px;
    }
    
    /* Left Queue Column */
    .validation-queue {
        background: var(--bg-dark);
        border: 1px solid var(--dark-gray);
        border-radius: 10px;
        padding: 15px;
        overflow-y: auto;
        overflow-x: hidden;
    }
    
    /* Middle Main Content */
    .validation-main {
        background: #000;
        border: 2px solid var(--orange);
        border-radius: 10px;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    /* Stats Bubbles in Header - Enlarged */
    .stats-bubbles {
        position: absolute;
        top: 15px;
        right: 20px;
        display: flex;
        gap: 20px;
        align-items: center;
    }
    
    .stat-bubble {
        background: rgba(0, 255, 255, 0.1);
        border: 2px solid var(--cyan);
        border-radius: 35px;
        padding: 12px 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 100px;
    }
    
    .stat-bubble-value {
        font-size: 28px;
        font-weight: bold;
        color: var(--orange);
        line-height: 1;
    }
    
    .stat-bubble-label {
        font-size: 11px;
        color: var(--gray);
        text-transform: uppercase;
        margin-top: 4px;
        letter-spacing: 1px;
    }
    
    /* Queue Items */
    .queue-item {
        background: rgba(255,140,0,0.1);
        border: 1px solid var(--orange);
        border-radius: 5px;
        padding: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .queue-item:hover {
        background: rgba(255,140,0,0.2);
        transform: translateX(5px);
    }
    
    .queue-item.active {
        background: rgba(255,140,0,0.3);
        border-width: 2px;
    }
    
    .queue-item-content {
        display: block;
        width: 100%;
    }
    
    .queue-item-thumb {
        width: 100%;
        height: 110px;
        overflow: hidden;
        border-radius: 5px;
        border: 1px solid var(--orange);
        background: #f5f5f5;
        margin-bottom: 8px;
    }
    
    .queue-item-thumb img {
        width: 100%;
        height: auto;
        object-fit: cover;
        object-position: top center;
    }
    
    .queue-item-info {
        flex: 1;
        min-width: 0;
    }
    
    .queue-item-store {
        font-weight: bold;
        color: var(--cyan);
        font-size: 11px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .queue-item-date {
        font-size: 9px;
        color: var(--gray);
    }
    
    .queue-item-amount {
        font-size: 10px;
        color: var(--yellow);
        margin-top: 2px;
    }
    
    /* Receipt Preview - Full height 3 columns */
    .receipt-preview {
        display: grid;
        grid-template-columns: 1fr 1fr 320px;
        gap: 15px;
        height: calc(100vh - 380px);
        min-height: 500px;
        overflow: hidden;
    }
    
    .receipt-image-section {
        background: #333;
        border-radius: 5px;
        padding: 10px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        max-height: 100%;
        position: relative;
    }
    
    .receipt-image {
        width: 100%;
        max-width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 10px;
        padding-top: 60px;
        position: relative;
        min-height: 500px;
    }
    
    /* Image Processing Toolbar */
    .image-toolbar {
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        display: flex;
        justify-content: space-between;
        gap: 5px;
        z-index: 10;
        background: rgba(0, 0, 0, 0.85);
        padding: 8px;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    
    .image-tool-group {
        display: flex;
        gap: 3px;
    }
    
    .image-tool-btn {
        background: rgba(0, 255, 255, 0.1);
        border: 1px solid #00ffff;
        color: #00ffff;
        padding: 5px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 3px;
    }
    
    .image-tool-btn:hover {
        background: rgba(0, 255, 255, 0.2);
        transform: translateY(-1px);
    }
    
    .image-tool-btn.active {
        background: rgba(255, 140, 0, 0.3);
        border-color: var(--orange);
        color: var(--orange);
    }
    
    /* Crop Tool UI */
    .crop-container {
        position: relative;
        display: inline-block;
        width: 100%;
    }
    
    .crop-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        display: none;
    }
    
    .crop-overlay.active {
        display: block;
        pointer-events: all;
    }
    
    .crop-box {
        position: absolute;
        border: 2px dashed #00ff88;
        background: rgba(0, 255, 136, 0.1);
        cursor: move;
        min-width: 20px;
        min-height: 20px;
    }
    
    .crop-handle {
        position: absolute;
        width: 12px;
        height: 12px;
        background: #00ff88;
        border: 2px solid #000;
        border-radius: 2px;
        box-shadow: 0 0 4px rgba(0, 255, 136, 0.5);
    }
    
    .crop-handle-tl { top: -6px; left: -6px; cursor: nw-resize; }
    .crop-handle-tr { top: -6px; right: -6px; cursor: ne-resize; }
    .crop-handle-bl { bottom: -6px; left: -6px; cursor: sw-resize; }
    .crop-handle-br { bottom: -6px; right: -6px; cursor: se-resize; }
    .crop-handle-t { top: -6px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
    .crop-handle-b { bottom: -6px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
    .crop-handle-l { left: -6px; top: 50%; transform: translateY(-50%); cursor: w-resize; }
    .crop-handle-r { right: -6px; top: 50%; transform: translateY(-50%); cursor: e-resize; }
    
    .crop-suggestion {
        position: absolute;
        border: 1px dotted rgba(255, 140, 0, 0.5);
        background: rgba(255, 140, 0, 0.05);
        pointer-events: none;
        transition: all 0.3s;
    }
    
    .crop-suggestion.active {
        border-color: rgba(255, 140, 0, 0.8);
        background: rgba(255, 140, 0, 0.1);
    }
    
    /* Image Adjustments Slider */
    .adjustment-controls {
        display: none;
        background: rgba(0, 0, 0, 0.9);
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        position: relative;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .adjustment-controls.active {
        display: block;
    }
    
    .adjustment-slider {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        color: #00ffff;
        font-size: 12px;
    }
    
    .adjustment-slider label {
        width: 80px;
        text-transform: lowercase;
    }
    
    .adjustment-slider input[type="range"] {
        flex: 1;
        height: 4px;
        background: rgba(0, 255, 255, 0.2);
        outline: none;
        -webkit-appearance: none;
    }
    
    .adjustment-slider input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        background: #00ffff;
        border-radius: 50%;
        cursor: pointer;
    }
    
    .adjustment-slider span {
        width: 40px;
        text-align: right;
        font-family: monospace;
    }
    
    /* Terminal Log Window */
    .terminal-log {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 600px;
        height: 400px;
        background: #0a0a0a;
        border: 2px solid var(--cyan);
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        z-index: 2000;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        transition: all 0.3s ease;
    }
    
    .terminal-log.minimized {
        height: 45px;
        width: 250px;
        overflow: hidden;
    }
    
    .terminal-log.minimized .terminal-body {
        display: none;
    }
    
    .terminal-header {
        background: linear-gradient(90deg, var(--cyan) 0%, var(--orange) 100%);
        color: #000;
        padding: 10px 15px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 8px 8px 0 0;
        cursor: move;
    }
    
    .terminal-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .terminal-minimize {
        cursor: pointer;
        font-size: 18px;
        transition: transform 0.3s;
    }
    
    .terminal-minimize:hover {
        transform: scale(1.2);
    }
    
    .terminal-close {
        cursor: pointer;
        font-size: 20px;
        transition: transform 0.3s;
    }
    
    .terminal-close:hover {
        transform: rotate(90deg);
    }
    
    /* Terminal Badge for new messages */
    .terminal-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--orange);
        color: #000;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .terminal-body {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        font-size: 13px;
        line-height: 1.5;
    }
    
    .terminal-line {
        margin-bottom: 5px;
        display: flex;
        align-items: flex-start;
    }
    
    .terminal-timestamp {
        color: #666;
        margin-right: 10px;
        font-size: 11px;
        min-width: 60px;
    }
    
    .terminal-level {
        margin-right: 10px;
        font-weight: bold;
        min-width: 60px;
    }
    
    .terminal-level.info {
        color: var(--cyan);
    }
    
    .terminal-level.success {
        color: var(--green);
    }
    
    .terminal-level.warning {
        color: var(--orange);
    }
    
    .terminal-level.error {
        color: #ff4444;
    }
    
    .terminal-level.debug {
        color: #888;
    }
    
    .terminal-message {
        flex: 1;
        word-wrap: break-word;
    }
    
    .terminal-json {
        background: rgba(0, 255, 255, 0.05);
        border-left: 2px solid var(--cyan);
        padding: 5px 10px;
        margin: 5px 0;
        font-size: 12px;
        color: #00ff88;
    }
    
    .terminal-progress {
        display: inline-block;
        width: 200px;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
        margin-left: 10px;
    }
    
    .terminal-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--cyan), var(--green));
        animation: progress 2s ease-in-out infinite;
    }
    
    @keyframes progress {
        0% { width: 0; }
        50% { width: 70%; }
        100% { width: 100%; }
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .receipt-image img {
        width: auto;
        height: auto;
        max-width: 100%;
        max-height: calc(100vh - 420px);
        min-height: 400px;
        object-fit: contain;
        object-position: center;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: zoom-in;
        display: block;
        margin: 0 auto;
    }
    
    .receipt-validation-section {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }
    
    .receipt-ocr {
        background: #0a0a0a;
        border: 1px solid #333;
        padding: 15px;
        border-radius: 5px;
        height: 100%;
        overflow-y: auto;
        flex: 1;
        min-height: 450px;
        position: relative;
    }
    
    .ocr-toolbar {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 5px;
        z-index: 10;
    }
    
    .ocr-tool-btn {
        background: rgba(0, 255, 255, 0.1);
        border: 1px solid var(--cyan);
        color: var(--cyan);
        padding: 5px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 3px;
    }
    
    .ocr-tool-btn:hover {
        background: rgba(0, 255, 255, 0.2);
        transform: translateY(-1px);
    }
    
    .ocr-tool-btn.active {
        background: rgba(0, 255, 255, 0.3);
        border-color: var(--orange);
        color: var(--orange);
    }
    
    .receipt-ocr pre {
        font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', monospace;
        font-size: 14px;
        line-height: 1.6;
        color: #00ff88;
        white-space: pre-wrap;
        word-wrap: break-word;
        letter-spacing: 0.5px;
    }
    
    /* Validation Form */
    .validation-form {
        background: rgba(0,255,0,0.05);
        border: 1px solid var(--green);
        border-radius: 5px;
        padding: 8px;
        height: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
    }
    
    .field-validation {
        display: grid;
        grid-template-columns: 90px 1fr 45px;
        gap: 3px;
        align-items: center;
        margin-bottom: 3px;
        padding: 4px 6px;
        background: rgba(0,0,0,0.5);
        border-radius: 3px;
    }
    
    .field-label {
        color: var(--cyan);
        font-weight: bold;
        text-transform: uppercase;
        font-size: 10px;
        letter-spacing: 0.3px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .field-value {
        background: #000;
        border: 1px solid var(--dark-gray);
        border-radius: 2px;
        padding: 4px;
        color: var(--yellow);
        font-family: 'JetBrains Mono', monospace;
        font-size: 11px;
        width: 100%;
        box-sizing: border-box;
    }
    
    .field-value::placeholder {
        color: #666;
        font-size: 13px;
    }
    
    .field-value.editable {
        border-color: var(--orange);
        cursor: text;
    }
    
    .field-value.editable:focus {
        outline: none;
        border-color: var(--cyan);
        box-shadow: 0 0 10px rgba(0,255,255,0.3);
    }
    
    /* Buttons */
    .validation-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-top: 8px;
        padding: 5px 0;
    }
    
    .btn-validate {
        background: linear-gradient(45deg, #00FF00, #00CC00);
        color: #000;
        border: none;
        padding: 8px 20px;
        border-radius: 3px;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-validate:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0,255,0,0.4);
    }
    
    .btn-reject {
        background: linear-gradient(45deg, #FF0000, #CC0000);
        color: #fff;
    }
    
    .btn-skip {
        background: linear-gradient(45deg, #666, #444);
        color: #fff;
    }
    
    /* Stats Cards */
    .stat-card {
        background: rgba(0,255,255,0.05);
        border: 1px solid var(--cyan);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: var(--orange);
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: var(--gray);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    /* Scrollbar Styling */
    .validation-queue::-webkit-scrollbar,
    .validation-stats::-webkit-scrollbar {
        width: 8px;
    }
    
    .validation-queue::-webkit-scrollbar-track,
    .validation-stats::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.3);
        border-radius: 4px;
    }
    
    .validation-queue::-webkit-scrollbar-thumb,
    .validation-stats::-webkit-scrollbar-thumb {
        background: var(--orange);
        border-radius: 4px;
        opacity: 0.7;
    }
    /* Top Toolbar */
    .top-toolbar {
        background: rgba(0,0,0,0.8);
        border: 1px solid var(--cyan);
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .toolbar-section {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .toolbar-separator {
        width: 1px;
        height: 30px;
        background: var(--cyan);
        opacity: 0.3;
    }
    
    .toolbar-btn {
        background: rgba(0,255,255,0.1);
        border: 1px solid var(--cyan);
        color: var(--cyan);
        padding: 8px 15px;
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .toolbar-btn:hover {
        background: rgba(0,255,255,0.2);
        transform: translateY(-1px);
        box-shadow: 0 2px 10px rgba(0,255,255,0.3);
    }
    
    .toolbar-info {
        color: var(--gray);
        font-size: 12px;
    }
    
    .osm-search-box {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
    }
    
    .osm-search-input {
        background: rgba(0,0,0,0.5);
        border: 1px solid var(--cyan);
        color: var(--cyan);
        padding: 6px 10px;
        border-radius: 3px;
        flex: 1;
        max-width: 300px;
    }
</style>

<div class="validation-container">
    <!-- Header with Stats Bubbles -->
    <div class="validation-header">
        <div class="stats-bubbles">
            <div class="stat-bubble">
                <div class="stat-bubble-value">{{ stats.validations_today|default:0 }}</div>
                <div class="stat-bubble-label">today</div>
            </div>
            <div class="stat-bubble">
                <div class="stat-bubble-value">{{ stats.total_validations|default:0 }}</div>
                <div class="stat-bubble-label">total</div>
            </div>
            <div class="stat-bubble">
                <div class="stat-bubble-value">{{ stats.accuracy|default:0 }}%</div>
                <div class="stat-bubble-label">accuracy</div>
            </div>
            <div class="stat-bubble" style="background: rgba(255,140,0,0.2); border-color: var(--orange);">
                <div class="stat-bubble-value">{{ profile.total_points|default:0 }}</div>
                <div class="stat-bubble-label">ü•ï carrots</div>
            </div>
        </div>
        
        <h1 style="color: var(--orange); font-size: 36px; margin: 0; text-transform: lowercase; letter-spacing: 3px;">
            validation hub
        </h1>
        <p style="color: var(--cyan); margin-top: 10px; font-size: 14px; text-transform: lowercase;">
            help validate receipts and earn carrots! each validation: +3 ü•ï | accurate validation: +5 ü•ï
        </p>
    </div>
    
    <div class="validation-grid">
        <!-- Left: Queue Section -->
        <div class="validation-queue">
            <h3 style="color: var(--orange); text-transform: lowercase; letter-spacing: 2px; margin-bottom: 20px;">
                validation queue
            </h3>
            
            {% if pending_validations %}
                {% for receipt in pending_validations %}
                <div class="queue-item {% if forloop.first %}active{% endif %}" 
                     data-receipt-id="{{ receipt.id }}"
                     onclick="loadReceipt(event, '{{ receipt.id }}')">
                    {% if receipt.thumbnail_path %}
                    <div class="queue-item-thumb">
                        <img src="{{ receipt.thumbnail_path.url }}" alt="Receipt" style="width: 100%; height: 100%; object-fit: cover; object-position: top;">
                    </div>
                    {% else %}
                    <div class="queue-item-thumb" style="background: rgba(255,140,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 32px;">
                        üìÑ
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; color: var(--gray); padding: 40px 0;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
                    <div style="text-transform: lowercase;">no receipts to validate</div>
                </div>
            {% endif %}
        </div>
        
        <!-- Middle: Main Validation Area -->
        <div class="validation-main">
            {% if current_receipt %}
            <h3 style="color: var(--cyan); text-transform: lowercase; letter-spacing: 2px; margin-bottom: 20px;">
                validate receipt data
            </h3>
            
            <!-- Receipt Preview - 3 Columns -->
            <div class="receipt-preview">
                <!-- Column 1: Receipt Image -->
                <div class="receipt-image-section">
                    <!-- Image Processing Toolbar -->
                    <div class="image-toolbar">
                        <div class="image-tool-group">
                            <button class="image-tool-btn" id="cropBtn" onclick="toggleCropMode()" title="Crop Image">
                                ‚úÇÔ∏è Crop
                            </button>
                            <button class="image-tool-btn" onclick="suggestCrop()" title="Auto-suggest Crop">
                                üéØ Suggest
                            </button>
                            <button class="image-tool-btn" id="cropConfirmBtn" onclick="applyCrop()" style="display:none; background: rgba(0,255,0,0.2); border-color: #00ff00; color: #00ff00;">
                                ‚úÖ Apply
                            </button>
                            <button class="image-tool-btn" id="cropCancelBtn" onclick="cancelCrop()" style="display:none; background: rgba(255,0,0,0.2); border-color: #ff0000; color: #ff0000;">
                                ‚ùå Cancel
                            </button>
                        </div>
                        <div class="image-tool-group">
                            <button class="image-tool-btn" onclick="toggleAdjustments()" title="Image Adjustments">
                                üé® Adjust
                            </button>
                            <button class="image-tool-btn" onclick="optimizeForOCR()" title="Optimize for OCR">
                                üîç OCR Optimize
                            </button>
                            <button class="image-tool-btn" onclick="resetImage()" title="Reset to Original">
                                üîÑ Reset
                            </button>
                        </div>
                    </div>
                    
                    {% if current_receipt.file_path %}
                    <div class="receipt-image">
                        <div class="crop-container">
                            <img id="receiptImage" src="{{ current_receipt.file_path.url }}?v={{ now|date:'U' }}" alt="Receipt image" onmousemove="zoomImage(event)" onmouseleave="resetZoom()">
                            
                            <!-- Crop Overlay -->
                            <div class="crop-overlay" id="cropOverlay">
                                <div class="crop-suggestion" id="cropSuggestion"></div>
                                <div class="crop-box" id="cropBox" style="display:none;">
                                    <div class="crop-handle crop-handle-tl"></div>
                                    <div class="crop-handle crop-handle-tr"></div>
                                    <div class="crop-handle crop-handle-bl"></div>
                                    <div class="crop-handle crop-handle-br"></div>
                                    <div class="crop-handle crop-handle-t"></div>
                                    <div class="crop-handle crop-handle-b"></div>
                                    <div class="crop-handle crop-handle-l"></div>
                                    <div class="crop-handle crop-handle-r"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Image Adjustment Controls -->
                        <div class="adjustment-controls" id="adjustmentControls">
                            <div class="adjustment-slider">
                                <label>brightness:</label>
                                <input type="range" id="brightnessSlider" min="50" max="150" value="100" oninput="applyImageFilters()">
                                <span id="brightnessValue">100%</span>
                            </div>
                            <div class="adjustment-slider">
                                <label>contrast:</label>
                                <input type="range" id="contrastSlider" min="50" max="200" value="100" oninput="applyImageFilters()">
                                <span id="contrastValue">100%</span>
                            </div>
                            <div class="adjustment-slider">
                                <label>sharpness:</label>
                                <input type="range" id="sharpnessSlider" min="0" max="10" value="0" step="0.1" oninput="applyImageFilters()">
                                <span id="sharpnessValue">0</span>
                            </div>
                            <div class="adjustment-slider">
                                <label>grayscale:</label>
                                <input type="range" id="grayscaleSlider" min="0" max="100" value="0" oninput="applyImageFilters()">
                                <span id="grayscaleValue">0%</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 5px; font-size: 10px; color: #666; text-align: center;">
                            hover to zoom | drag to crop
                        </div>
                    </div>
                    {% else %}
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="font-size: 64px;">üìÑ</div>
                        <div>No image available</div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Column 2: OCR Text -->
                <div class="receipt-ocr">
                    <div class="ocr-toolbar">
                        <button class="ocr-tool-btn" onclick="rescanOCR()" title="Rescan OCR">
                            üîÑ Rescan
                        </button>
                        <button class="ocr-tool-btn" onclick="editOCR()" title="Edit OCR Text">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="ocr-tool-btn" onclick="askLLM()" title="Ask LLM to Extract Fields">
                            ü§ñ AI Extract
                        </button>
                        <button class="ocr-tool-btn" onclick="searchNearbyBusiness()" title="Search Nearby Businesses">
                            üìç Nearby
                        </button>
                        <button class="ocr-tool-btn" onclick="autoFillForm()" title="Auto-fill Form">
                            ‚ö° Auto-Fill
                        </button>
                    </div>
                    <div style="color: var(--green); font-size: 11px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold;">
                        üìù OCR TEXT:
                    </div>
                    <pre id="ocrTextContent">{{ current_receipt.ocr_text|default:"[no ocr text available]" }}</pre>
                </div>
                
                <!-- Column 3: Validation Form -->
                <div class="receipt-validation-section">
                    <!-- OSM Search Box (moved from top toolbar) -->
                    <div style="background: rgba(0,0,0,0.5); border: 1px solid var(--cyan); border-radius: 3px; padding: 8px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="ocr-tool-btn" onclick="autoDetectBusiness()" title="Auto-detect from OCR" style="padding: 5px 8px; font-size: 11px;">
                                üîç Detect
                            </button>
                            <input type="text" id="osmSearchInput" class="osm-search-input" 
                                   placeholder="Search business..." 
                                   onkeypress="if(event.key=='Enter') osmQuickSearch()"
                                   style="flex: 1; background: rgba(0,0,0,0.5); border: 1px solid var(--cyan); color: var(--cyan); padding: 4px 8px; border-radius: 2px; font-size: 11px;">
                            <button class="ocr-tool-btn" onclick="osmQuickSearch()" title="Search OSM" style="padding: 5px 8px; font-size: 11px;">
                                üó∫Ô∏è OSM
                            </button>
                        </div>
                    </div>
                    
                    <div class="validation-form">
                        <form id="validationForm" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="receipt_id" value="{{ current_receipt.id }}">
                            
                            <div style="flex: 1; overflow-y: auto; padding-right: 3px; max-height: calc(100vh - 450px);">
                                <div class="field-validation">
                                    <span class="field-label">Store Name:</span>
                                    <input type="text" class="field-value editable" 
                                           name="store_name" 
                                           value="{{ current_receipt.parsed_receipt.store_name|default:'' }}"
                                           placeholder="e.g. Migros, Bƒ∞M, A101">
                                    <span style="color: var(--green); font-size: 9px;">+3ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">Date:</span>
                                    <input type="date" class="field-value editable" 
                                           name="date"
                                           value="{{ current_receipt.parsed_receipt.transaction_date|date:'Y-m-d'|default:'' }}">
                                    <span style="color: var(--green); font-size: 9px;">+2ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">Time:</span>
                                    <input type="time" class="field-value editable" 
                                           name="time"
                                           value="{{ current_receipt.parsed_receipt.transaction_time|default:'' }}"
                                           placeholder="HH:MM">
                                    <span style="color: var(--green); font-size: 9px;">+2ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">Receipt #:</span>
                                    <input type="text" class="field-value editable" 
                                           name="receipt_number"
                                           value="{{ current_receipt.parsed_receipt.receipt_number|default:'' }}"
                                           placeholder="Fƒ∞≈û NO">
                                    <span style="color: var(--green); font-size: 9px;">+2ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">Subtotal:</span>
                                    <input type="number" step="0.01" class="field-value editable" 
                                           name="subtotal"
                                           value="{{ current_receipt.parsed_receipt.subtotal|default:'' }}"
                                           placeholder="0.00">
                                    <span style="color: var(--green); font-size: 9px;">+3ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">KDV Amount:</span>
                                    <input type="number" step="0.01" class="field-value editable" 
                                           name="tax_amount"
                                           value="{{ current_receipt.parsed_receipt.tax_amount|default:'' }}"
                                           placeholder="0.00">
                                    <span style="color: var(--green); font-size: 9px;">+3ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">Total Amount:</span>
                                    <input type="number" step="0.01" class="field-value editable" 
                                           name="total_amount"
                                           value="{{ current_receipt.parsed_receipt.total_amount|default:'' }}"
                                           placeholder="0.00">
                                    <span style="color: var(--green); font-size: 9px;">+5ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">Payment:</span>
                                    <select class="field-value editable" name="payment_method">
                                        <option value="">Select...</option>
                                        <option value="cash">Nakit</option>
                                        <option value="card">Kredi Kartƒ±</option>
                                        <option value="meal">Yemek Kartƒ±</option>
                                        <option value="other">Diƒüer</option>
                                    </select>
                                    <span style="color: var(--green); font-size: 9px;">+2ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">Item Count:</span>
                                    <input type="number" class="field-value editable" 
                                           name="item_count"
                                           value="{{ current_receipt.parsed_receipt.item_count|default:'' }}"
                                           placeholder="0">
                                    <span style="color: var(--green); font-size: 9px;">+2ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">Store Address:</span>
                                    <input type="text" class="field-value editable" 
                                           name="store_address"
                                           value="{{ current_receipt.parsed_receipt.store_address|default:'' }}"
                                           placeholder="Maƒüaza adresi">
                                    <span style="color: var(--green); font-size: 9px;">+2ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">Store Phone:</span>
                                    <input type="tel" class="field-value editable" 
                                           name="store_phone"
                                           value="{{ current_receipt.parsed_receipt.store_phone|default:'' }}"
                                           placeholder="0XXX XXX XX XX">
                                    <span style="color: var(--green); font-size: 9px;">+1ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">Cashier:</span>
                                    <input type="text" class="field-value editable" 
                                           name="cashier_name"
                                           value="{{ current_receipt.parsed_receipt.cashier_name|default:'' }}"
                                           placeholder="Kasiyer adƒ±">
                                    <span style="color: var(--green); font-size: 9px;">+1ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">POS Terminal:</span>
                                    <input type="text" class="field-value editable" 
                                           name="pos_terminal"
                                           value="{{ current_receipt.parsed_receipt.pos_terminal|default:'' }}"
                                           placeholder="POS/Kasa No">
                                    <span style="color: var(--green); font-size: 9px;">+1ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">Card Last 4:</span>
                                    <input type="text" class="field-value editable" 
                                           name="card_last_four"
                                           maxlength="4"
                                           value="{{ current_receipt.parsed_receipt.card_last_four|default:'' }}"
                                           placeholder="XXXX">
                                    <span style="color: var(--green); font-size: 9px;">+2ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">Doc Type:</span>
                                    <select class="field-value editable" name="document_type">
                                        <option value="receipt" selected>Fi≈ü</option>
                                        <option value="invoice">Fatura</option>
                                        <option value="refund">ƒ∞ade Fi≈üi</option>
                                        <option value="warranty">Garanti Belgesi</option>
                                        <option value="delivery">Teslimat Makbuzu</option>
                                    </select>
                                    <span style="color: var(--green); font-size: 9px;">+3ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">Currency:</span>
                                    <select class="field-value editable" name="currency">
                                        <option value="TRY" selected>TRY ‚Ç∫</option>
                                        <option value="USD">USD $</option>
                                        <option value="EUR">EUR ‚Ç¨</option>
                                        <option value="GBP">GBP ¬£</option>
                                    </select>
                                    <span style="color: var(--green); font-size: 9px;">+1ü•ï</span>
                                </div>
                                
                                <div class="field-validation">
                                    <span class="field-label">Notes:</span>
                                    <textarea class="field-value editable" 
                                              name="notes"
                                              rows="2"
                                              placeholder="Ekstra notlar...">{{ current_receipt.parsed_receipt.notes|default:'' }}</textarea>
                                    <span style="color: var(--green); font-size: 9px;">+1ü•ï</span>
                                </div>
                            </div>
                        </form>
                        
                        <div class="validation-buttons" style="margin-top: 5px; flex-shrink: 0;">
                            <button type="button" class="btn-validate btn-reject" onclick="rejectReceipt()">
                                ‚ùå Reject
                            </button>
                            <button type="button" class="btn-validate btn-skip" onclick="skipReceipt()">
                                ‚è≠Ô∏è Skip
                            </button>
                            <button type="button" class="btn-validate" onclick="validateReceipt()">
                                ‚úÖ Validate
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div style="text-align: center; padding: 60px 0; color: var(--gray);">
                <div style="font-size: 64px; margin-bottom: 20px;">ü•ï</div>
                <h3 style="color: var(--orange);">Ready to Validate!</h3>
                <p>Select a receipt from the queue to start earning carrots</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function loadReceipt(event, receiptId) {
        // Prevent any bubbling
        event.stopPropagation();
        
        // Update active queue item
        document.querySelectorAll('.queue-item').forEach(item => {
            item.classList.remove('active');
        });
        event.currentTarget.classList.add('active');
        
        // Reload page with receipt ID as parameter
        // This ensures server-side rendering of the new receipt
        window.location.href = `/documents/document-validation/?receipt_id=${receiptId}`;
    }
    
    function validateReceipt() {
        const form = document.getElementById('validationForm');
        const formData = new FormData(form);
        
        fetch('/documents/document-validation/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
    
    function rejectReceipt() {
        if (confirm('Are you sure you want to reject this receipt?')) {
            skipReceipt();
        }
    }
    
    function skipReceipt() {
        location.reload();
    }
    
    // Zoom functions
    function zoomImage(event) {
        const img = event.target;
        const rect = img.getBoundingClientRect();
        const x = ((event.clientX - rect.left) / rect.width) * 100;
        const y = ((event.clientY - rect.top) / rect.height) * 100;
        
        img.style.transformOrigin = `${x}% ${y}%`;
        img.style.transform = 'scale(2)';
        img.style.cursor = 'zoom-out';
        img.style.zIndex = '1000';
        img.style.position = 'relative';
    }
    
    function resetZoom() {
        const img = event.target;
        img.style.transform = 'scale(1)';
        img.style.cursor = 'zoom-in';
        img.style.zIndex = 'auto';
    }
    
    // OCR Toolbar Functions
    // Terminal logging system
    let terminalLog = null;
    let logLines = [];
    let isMinimized = false;
    let unreadCount = 0;
    
    function createTerminal() {
        if (!terminalLog) {
            terminalLog = document.createElement('div');
            terminalLog.className = 'terminal-log';
            terminalLog.innerHTML = `
                <div class="terminal-header" id="terminalHeader">
                    <span>üñ•Ô∏è Process Monitor</span>
                    <div class="terminal-controls">
                        <span class="terminal-minimize" onclick="toggleMinimize()">_</span>
                        <span class="terminal-close" onclick="closeTerminal()">‚úï</span>
                    </div>
                    <span class="terminal-badge" id="terminalBadge" style="display: none;">0</span>
                </div>
                <div class="terminal-body" id="terminalBody"></div>
            `;
            document.body.appendChild(terminalLog);
            
            // Make terminal draggable
            makeDraggable(terminalLog);
        }
        return document.getElementById('terminalBody');
    }
    
    function toggleMinimize() {
        if (!terminalLog) return;
        
        isMinimized = !isMinimized;
        if (isMinimized) {
            terminalLog.classList.add('minimized');
            // Reset unread count when maximizing
            unreadCount = 0;
            updateBadge();
        } else {
            terminalLog.classList.remove('minimized');
            // Hide badge when maximized
            document.getElementById('terminalBadge').style.display = 'none';
        }
    }
    
    function updateBadge() {
        const badge = document.getElementById('terminalBadge');
        if (!badge) return;
        
        if (isMinimized && unreadCount > 0) {
            badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }
    
    function makeDraggable(element) {
        const header = element.querySelector('.terminal-header');
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;
        
        header.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
        
        function dragStart(e) {
            if (e.target.classList.contains('terminal-minimize') || 
                e.target.classList.contains('terminal-close')) {
                return;
            }
            
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
            
            if (e.target === header || header.contains(e.target)) {
                isDragging = true;
            }
        }
        
        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                
                xOffset = currentX;
                yOffset = currentY;
                
                element.style.transform = `translate(${currentX}px, ${currentY}px)`;
            }
        }
        
        function dragEnd(e) {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
        }
    }
    
    function closeTerminal() {
        if (terminalLog) {
            terminalLog.remove();
            terminalLog = null;
        }
    }
    
    // Auto-create terminal on page load
    window.addEventListener('DOMContentLoaded', () => {
        createTerminal();
        log('üöÄ Process Monitor initialized', 'info');
        log('üìä Ready to track OCR and AI operations', 'info');
    });
    
    function log(message, level = 'info', data = null) {
        const terminal = createTerminal();
        const timestamp = new Date().toLocaleTimeString('tr-TR', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit' 
        });
        
        const line = document.createElement('div');
        line.className = 'terminal-line';
        
        line.innerHTML = `
            <span class="terminal-timestamp">${timestamp}</span>
            <span class="terminal-level ${level}">[${level.toUpperCase()}]</span>
            <span class="terminal-message">${message}</span>
        `;
        
        terminal.appendChild(line);
        
        // Add JSON data if provided
        if (data) {
            const jsonBlock = document.createElement('pre');
            jsonBlock.className = 'terminal-json';
            jsonBlock.textContent = JSON.stringify(data, null, 2);
            terminal.appendChild(jsonBlock);
        }
        
        // Update unread count if minimized
        if (isMinimized) {
            unreadCount++;
            updateBadge();
        }
        
        // Auto-scroll to bottom
        terminal.scrollTop = terminal.scrollHeight;
    }
    
    function logProgress(message) {
        const terminal = createTerminal();
        const timestamp = new Date().toLocaleTimeString('tr-TR', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit' 
        });
        
        const line = document.createElement('div');
        line.className = 'terminal-line';
        
        line.innerHTML = `
            <span class="terminal-timestamp">${timestamp}</span>
            <span class="terminal-level info">[PROCESS]</span>
            <span class="terminal-message">${message}
                <span class="terminal-progress">
                    <div class="terminal-progress-bar"></div>
                </span>
            </span>
        `;
        
        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;
        return line;
    }
    
    function rescanOCR() {
        const receiptId = '{{ current_receipt.id }}';
        
        log('üîÑ Starting OCR rescan with gentle preprocessing...', 'info');
        log('üéØ Applying gentle enhancement: contrast, brightness, light denoise', 'info');
        log(`Receipt ID: ${receiptId}`, 'debug');
        
        // Update status
        document.getElementById('ocrStatus').textContent = 'OCR: Processing...';
        
        const progressLine = logProgress('Sending request to server...');
        
        fetch(`/documents/receipts/rescan-ocr/${receiptId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            log(`Server response: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                log('‚úÖ OCR rescan completed successfully!', 'success');
                log(`OCR Text Length: ${data.ocr_text ? data.ocr_text.length : 0} characters`, 'info');
                log(`Confidence: ${data.confidence || 'N/A'}%`, 'info');
                
                if (data.ocr_text) {
                    document.getElementById('ocrTextContent').textContent = data.ocr_text;
                    log('üìù OCR text updated in UI', 'success');
                    document.getElementById('ocrStatus').textContent = 'OCR: Complete';
                    
                    // Show first 200 chars of OCR text
                    log('Preview:', 'debug', {
                        text_preview: data.ocr_text.substring(0, 200) + '...'
                    });
                }
                
                showNotification('OCR rescanned successfully!', 'success');
            } else {
                log('‚ùå OCR rescan failed', 'error');
                log(`Error: ${data.error || 'Unknown error'}`, 'error');
                showNotification('Failed to rescan OCR', 'error');
            }
        })
        .catch(error => {
            log('üö® Network or processing error', 'error');
            log(error.message, 'error');
            log('Stack trace:', 'debug', { stack: error.stack });
            showNotification('OCR rescan error: ' + error.message, 'error');
        });
    }
    
    function editOCR() {
        const ocrPre = document.getElementById('ocrTextContent');
        const currentText = ocrPre.textContent;
        
        // Convert to editable textarea
        const textarea = document.createElement('textarea');
        textarea.value = currentText;
        textarea.style.width = '100%';
        textarea.style.height = '400px';
        textarea.style.background = '#0a0a0a';
        textarea.style.color = '#00ff88';
        textarea.style.border = '1px solid var(--cyan)';
        textarea.style.padding = '10px';
        textarea.style.fontFamily = 'JetBrains Mono, monospace';
        textarea.style.fontSize = '14px';
        
        ocrPre.replaceWith(textarea);
        textarea.focus();
        
        // Add save button
        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'üíæ Save OCR';
        saveBtn.className = 'ocr-tool-btn';
        saveBtn.onclick = () => {
            const newText = textarea.value;
            const pre = document.createElement('pre');
            pre.id = 'ocrTextContent';
            pre.textContent = newText;
            textarea.replaceWith(pre);
            saveBtn.remove();
            
            // Save to backend
            saveOCRText(newText);
        };
        textarea.after(saveBtn);
    }
    
    function saveOCRText(text) {
        const receiptId = '{{ current_receipt.id }}';
        fetch(`/documents/receipts/update-ocr/${receiptId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ocr_text: text })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('OCR text updated!', 'success');
            }
        });
    }
    
    function askLLM() {
        const ocrText = document.getElementById('ocrTextContent').textContent;
        
        log('ü§ñ Starting AI extraction process...', 'info');
        log(`OCR text length: ${ocrText.length} characters`, 'debug');
        
        if (!ocrText || ocrText.length < 10) {
            log('‚ö†Ô∏è OCR text too short or empty', 'warning');
            showNotification('Please rescan OCR first', 'warning');
            return;
        }
        
        const requestData = {
            ocr_text: ocrText,
            receipt_id: '{{ current_receipt.id }}'
        };
        
        log('üì§ Sending to AI service...', 'info');
        log('Request payload:', 'debug', {
            text_length: ocrText.length,
            receipt_id: requestData.receipt_id
        });
        
        const progressLine = logProgress('AI is analyzing receipt content...');
        
        fetch('/documents/receipts/ai-extract/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            log(`AI service response: ${response.status}`, response.ok ? 'success' : 'error');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.fields) {
                log('‚úÖ AI extraction successful!', 'success');
                log('Extracted fields:', 'info', data.fields);
                
                // Count extracted fields
                const fieldCount = Object.keys(data.fields).length;
                log(`üìä Found ${fieldCount} fields`, 'info');
                
                // Auto-fill form with extracted data
                fillFormWithData(data.fields);
                log('üìù Form auto-filled with AI data', 'success');
                
                // Log extraction method
                if (data.method) {
                    log(`Extraction method: ${data.method}`, 'debug');
                }
                
                // Check for OSM enrichment
                if (data.osm_enrichment && Object.keys(data.osm_enrichment).length > 0) {
                    log('üó∫Ô∏è OpenStreetMap enrichment found!', 'success');
                    log('OSM Data:', 'info', data.osm_enrichment);
                    
                    // Show enriched fields
                    const enrichedFields = [];
                    if (data.osm_enrichment.phone) enrichedFields.push('phone');
                    if (data.osm_enrichment.address) enrichedFields.push('address');
                    if (data.osm_enrichment.website) enrichedFields.push('website');
                    if (data.osm_enrichment.opening_hours) enrichedFields.push('hours');
                    
                    if (enrichedFields.length > 0) {
                        log(`üìç Enriched fields: ${enrichedFields.join(', ')}`, 'success');
                    }
                }
                
                showNotification(`AI extracted ${fieldCount} fields!`, 'success');
            } else {
                log('‚ùå AI extraction failed', 'error');
                log(`Error: ${data.error || 'No fields extracted'}`, 'error');
                
                if (data.fallback) {
                    log('‚ö†Ô∏è Using fallback pattern matching', 'warning');
                }
                
                showNotification('AI extraction failed: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            log('üö® AI service error', 'error');
            log(error.message, 'error');
            log('Stack trace:', 'debug', { stack: error.stack });
            
            // Check if Ollama is running
            log('üí° Hint: Make sure Ollama is running (ollama serve)', 'warning');
            
            showNotification('AI error: ' + error.message, 'error');
        });
    }
    
    function autoFillForm() {
        const ocrText = document.getElementById('ocrTextContent').textContent;
        
        log('‚ö° Starting auto-fill process...', 'info');
        log('Using pattern matching for field extraction', 'debug');
        
        // Simple pattern matching for common fields
        const patterns = {
            store_name: /^([A-Z√áƒûƒ∞√ñ≈û√ú\s]+)/m,
            date: /(\d{2}[./-]\d{2}[./-]\d{4})/,
            time: /(\d{2}:\d{2})/,
            receipt_number: /Fƒ∞≈û\s*NO\s*:\s*(\d+)/i,
            total_amount: /TOPLAM\s*:?\s*([\d,]+\.?\d*)/i,
            subtotal: /ARA\s*TOPLAM\s*:?\s*([\d,]+\.?\d*)/i,
            tax_amount: /KDV\s*%?\d*\s*:?\s*([\d,]+\.?\d*)/i,
            card_last_four: /KART\s*NO\s*:?\s*[X*]+(\d{4})/i,
            pos_terminal: /TERMƒ∞NAL\s*:?\s*(\w+)/i,
            cashier: /KASƒ∞YER\s*:?\s*(\w+)/i
        };
        
        const extractedData = {};
        
        for (const [field, pattern] of Object.entries(patterns)) {
            const match = ocrText.match(pattern);
            if (match) {
                let value = match[1];
                // Clean up monetary values
                if (['total_amount', 'subtotal', 'tax_amount'].includes(field)) {
                    value = value.replace(',', '.');
                }
                // Convert date format
                if (field === 'date' && value.includes('.')) {
                    const parts = value.split('.');
                    if (parts.length === 3) {
                        value = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                }
                extractedData[field] = value;
            }
        }
        
        log('Extracted data:', 'info', extractedData);
        const fieldCount = Object.keys(extractedData).length;
        log(`üìä Extracted ${fieldCount} fields using patterns`, 'info');
        
        fillFormWithData(extractedData);
        log('‚úÖ Form auto-filled successfully!', 'success');
        showNotification(`Auto-filled ${fieldCount} fields from OCR!`, 'success');
    }
    
    function fillFormWithData(data) {
        for (const [field, value] of Object.entries(data)) {
            const input = document.querySelector(`[name="${field}"]`);
            if (input && value) {
                input.value = value;
                // Highlight filled fields
                input.style.borderColor = 'var(--green)';
                setTimeout(() => {
                    input.style.borderColor = '';
                }, 2000);
            }
        }
    }
    
    function showLoading(message) {
        const loading = document.createElement('div');
        loading.id = 'loadingOverlay';
        loading.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            border: 2px solid var(--cyan);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            color: var(--cyan);
        `;
        loading.innerHTML = `<div>üîÑ ${message}</div>`;
        document.body.appendChild(loading);
    }
    
    function hideLoading() {
        const loading = document.getElementById('loadingOverlay');
        if (loading) loading.remove();
    }
    
    function showNotification(message, type) {
        // Also log to terminal
        if (type === 'success') {
            log(`‚úÖ ${message}`, 'success');
        } else if (type === 'error') {
            log(`‚ùå ${message}`, 'error');
        } else if (type === 'warning') {
            log(`‚ö†Ô∏è ${message}`, 'warning');
        } else {
            log(`‚ÑπÔ∏è ${message}`, 'info');
        }
        
        const notification = document.createElement('div');
        const bgColor = type === 'success' ? 'var(--green)' : 
                       type === 'warning' ? 'var(--orange)' : 
                       type === 'error' ? '#ff4444' : 'var(--cyan)';
        
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${bgColor};
            color: #000;
            padding: 20px 30px;
            border-radius: 8px;
            z-index: 3000;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
    
    // Image Processing Functions
    let cropMode = false;
    let cropBox = null;
    let originalImageData = null;
    let cropStartX, cropStartY;
    let isDragging = false;
    let isResizing = false;
    let resizeHandle = null;
    let currentCropArea = null; // Store current crop area
    
    function toggleCropMode() {
        cropMode = !cropMode;
        const overlay = document.getElementById('cropOverlay');
        const cropBtn = document.getElementById('cropBtn');
        const confirmBtn = document.getElementById('cropConfirmBtn');
        const cancelBtn = document.getElementById('cropCancelBtn');
        
        if (cropMode) {
            overlay.classList.add('active');
            cropBtn.classList.add('active');
            confirmBtn.style.display = 'inline-flex';
            cancelBtn.style.display = 'inline-flex';
            initCropTool();
            
            // Restore previous crop area if exists
            if (currentCropArea) {
                cropBox = document.getElementById('cropBox');
                cropBox.style.display = 'block';
                cropBox.style.left = currentCropArea.left + 'px';
                cropBox.style.top = currentCropArea.top + 'px';
                cropBox.style.width = currentCropArea.width + 'px';
                cropBox.style.height = currentCropArea.height + 'px';
            }
            
            showNotification('Crop mode activated - drag to select area', 'info');
        } else {
            overlay.classList.remove('active');
            cropBtn.classList.remove('active');
            confirmBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            // Don't remove crop box, just hide overlay
            showNotification('Crop mode deactivated', 'info');
        }
    }
    
    function initCropTool() {
        const container = document.querySelector('.crop-container');
        const overlay = document.getElementById('cropOverlay');
        
        overlay.addEventListener('mousedown', startCrop);
        overlay.addEventListener('mousemove', dragCrop);
        overlay.addEventListener('mouseup', endCrop);
    }
    
    function startCrop(e) {
        if (e.target.classList.contains('crop-handle')) {
            isResizing = true;
            resizeHandle = e.target.className.split(' ')[1];
            return;
        }
        
        if (e.target === document.getElementById('cropBox')) {
            isDragging = true;
            const rect = e.target.getBoundingClientRect();
            const parentRect = e.currentTarget.getBoundingClientRect();
            cropStartX = e.clientX - parentRect.left;
            cropStartY = e.clientY - parentRect.top;
            return;
        }
        
        // Check if clicking outside crop box when it exists
        if (cropBox && cropBox.style.display === 'block') {
            // Keep existing crop box, allow modifying
            return;
        }
        
        // Start new crop selection
        const rect = e.currentTarget.getBoundingClientRect();
        cropStartX = e.clientX - rect.left;
        cropStartY = e.clientY - rect.top;
        
        cropBox = document.getElementById('cropBox');
        cropBox.style.display = 'block';
        cropBox.style.left = cropStartX + 'px';
        cropBox.style.top = cropStartY + 'px';
        cropBox.style.width = '0px';
        cropBox.style.height = '0px';
        
        isDragging = true;
    }
    
    function dragCrop(e) {
        if (!isDragging && !isResizing) return;
        
        const rect = e.currentTarget.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;
        
        if (isResizing) {
            resizeCropBox(currentX, currentY);
        } else if (cropBox) {
            const width = Math.abs(currentX - cropStartX);
            const height = Math.abs(currentY - cropStartY);
            const left = Math.min(currentX, cropStartX);
            const top = Math.min(currentY, cropStartY);
            
            cropBox.style.left = left + 'px';
            cropBox.style.top = top + 'px';
            cropBox.style.width = width + 'px';
            cropBox.style.height = height + 'px';
        }
    }
    
    function endCrop() {
        isDragging = false;
        isResizing = false;
        resizeHandle = null;
        
        // Store current crop area
        if (cropBox && cropBox.style.display === 'block') {
            currentCropArea = {
                left: parseInt(cropBox.style.left),
                top: parseInt(cropBox.style.top),
                width: parseInt(cropBox.style.width),
                height: parseInt(cropBox.style.height)
            };
        }
    }
    
    function resizeCropBox(x, y) {
        if (!cropBox || !resizeHandle) return;
        
        const rect = cropBox.getBoundingClientRect();
        const parentRect = cropBox.parentElement.getBoundingClientRect();
        
        if (resizeHandle.includes('l')) {
            const newWidth = rect.right - (x + parentRect.left);
            cropBox.style.width = newWidth + 'px';
            cropBox.style.left = (x) + 'px';
        }
        if (resizeHandle.includes('r')) {
            cropBox.style.width = (x - (rect.left - parentRect.left)) + 'px';
        }
        if (resizeHandle.includes('t')) {
            const newHeight = rect.bottom - (y + parentRect.top);
            cropBox.style.height = newHeight + 'px';
            cropBox.style.top = (y) + 'px';
        }
        if (resizeHandle.includes('b')) {
            cropBox.style.height = (y - (rect.top - parentRect.top)) + 'px';
        }
    }
    
    function suggestCrop() {
        // AI-based crop suggestion - detect document edges
        const img = document.getElementById('receiptImage');
        const suggestion = document.getElementById('cropSuggestion');
        
        log('üéØ Analyzing image for optimal crop area...', 'info');
        
        // Improved edge detection simulation
        const imgRect = img.getBoundingClientRect();
        const parentRect = img.parentElement.getBoundingClientRect();
        
        // Smart margin detection based on image aspect ratio
        const aspectRatio = imgRect.width / imgRect.height;
        let marginX = 0.08; // 8% default
        let marginY = 0.05; // 5% default
        
        // Adjust margins based on aspect ratio
        if (aspectRatio > 1.5) {
            // Wide image - likely has more horizontal padding
            marginX = 0.12;
            marginY = 0.03;
        } else if (aspectRatio < 0.7) {
            // Tall image - likely a receipt
            marginX = 0.05;
            marginY = 0.08;
        }
        
        // Apply suggestion
        const left = imgRect.width * marginX;
        const top = imgRect.height * marginY;
        const width = imgRect.width * (1 - 2 * marginX);
        const height = imgRect.height * (1 - 2 * marginY);
        
        suggestion.style.left = left + 'px';
        suggestion.style.top = top + 'px';
        suggestion.style.width = width + 'px';
        suggestion.style.height = height + 'px';
        suggestion.classList.add('active');
        
        // Auto-apply suggestion to crop box
        if (!cropBox) {
            cropBox = document.getElementById('cropBox');
        }
        cropBox.style.display = 'block';
        cropBox.style.left = left + 'px';
        cropBox.style.top = top + 'px';
        cropBox.style.width = width + 'px';
        cropBox.style.height = height + 'px';
        
        // Store as current crop area
        currentCropArea = { left, top, width, height };
        
        log(`üìê Suggested crop: ${Math.round(width)}x${Math.round(height)}px with ${Math.round(marginX*100)}% margins`, 'success');
        showNotification('Smart crop area detected and applied!', 'success');
        
        // Auto-remove suggestion overlay after 2 seconds
        setTimeout(() => {
            suggestion.classList.remove('active');
        }, 2000);
    }
    
    function applyCrop() {
        if (!cropBox) {
            showNotification('No crop area selected', 'error');
            return;
        }
        
        const img = document.getElementById('receiptImage');
        const rect = cropBox.getBoundingClientRect();
        const imgRect = img.getBoundingClientRect();
        
        // Calculate crop coordinates relative to image
        const cropData = {
            x: (rect.left - imgRect.left) / imgRect.width,
            y: (rect.top - imgRect.top) / imgRect.height,
            width: rect.width / imgRect.width,
            height: rect.height / imgRect.height
        };
        
        // Send crop data to backend
        fetch(`/documents/receipts/crop-image/{{ current_receipt.id }}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(cropData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update image with cropped version
                img.src = data.cropped_url + '?v=' + Date.now();
                log(`‚úÇÔ∏è Image cropped: ${Math.round(cropData.width * 100)}% x ${Math.round(cropData.height * 100)}% of original`, 'success');
                showNotification('‚úÇÔ∏è Crop applied successfully!', 'success');
                cancelCrop();
            } else {
                showNotification('Crop failed: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            log(`‚ùå Crop error: ${error.message}`, 'error');
            showNotification('Crop failed: ' + error.message, 'error');
        });
    }
    
    function cancelCrop() {
        toggleCropMode();
        removeCropBox();
    }
    
    function removeCropBox() {
        const box = document.getElementById('cropBox');
        if (box) {
            box.style.display = 'none';
        }
    }
    
    function toggleAdjustments() {
        const controls = document.getElementById('adjustmentControls');
        controls.classList.toggle('active');
    }
    
    function applyImageFilters() {
        const img = document.getElementById('receiptImage');
        const brightness = document.getElementById('brightnessSlider').value;
        const contrast = document.getElementById('contrastSlider').value;
        const sharpness = document.getElementById('sharpnessSlider').value;
        const grayscale = document.getElementById('grayscaleSlider').value;
        
        // Update display values
        document.getElementById('brightnessValue').textContent = brightness + '%';
        document.getElementById('contrastValue').textContent = contrast + '%';
        document.getElementById('sharpnessValue').textContent = sharpness;
        document.getElementById('grayscaleValue').textContent = grayscale + '%';
        
        // Apply CSS filters
        const filters = [
            `brightness(${brightness}%)`,
            `contrast(${contrast}%)`,
            `grayscale(${grayscale}%)`
        ];
        
        // Sharpness simulation using contrast
        if (sharpness > 0) {
            filters.push(`contrast(${100 + sharpness * 10}%)`);
        }
        
        img.style.filter = filters.join(' ');
    }
    
    function optimizeForOCR() {
        // Auto-adjust for optimal OCR
        document.getElementById('brightnessSlider').value = 110;
        document.getElementById('contrastSlider').value = 120;
        document.getElementById('sharpnessSlider').value = 2;
        document.getElementById('grayscaleSlider').value = 100;
        
        applyImageFilters();
        
        // Send optimization request to backend
        fetch(`/documents/receipts/optimize-for-ocr/{{ current_receipt.id }}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Image optimized for OCR!', 'success');
                // Trigger OCR rescan
                setTimeout(() => rescanOCR(), 500);
            }
        });
    }
    
    function resetImage() {
        // Reset all adjustments
        document.getElementById('brightnessSlider').value = 100;
        document.getElementById('contrastSlider').value = 100;
        document.getElementById('sharpnessSlider').value = 0;
        document.getElementById('grayscaleSlider').value = 0;
        
        applyImageFilters();
        
        // Reset to original image
        const img = document.getElementById('receiptImage');
        img.style.filter = 'none';
        
        // Request original from backend
        fetch(`/documents/receipts/reset-image/{{ current_receipt.id }}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                img.src = data.original_url + '?v=' + Date.now();
                log('üîÑ Image restored to original version', 'success');
                showNotification('üîÑ Image restored to original!', 'success');
                
                // Clear crop area
                currentCropArea = null;
                if (cropBox) {
                    cropBox.style.display = 'none';
                }
            } else {
                showNotification('Reset failed: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            log(`‚ùå Reset error: ${error.message}`, 'error');
            showNotification('Reset failed: ' + error.message, 'error');
        });
    }
    
    // OSM Toolbar Functions
    function osmQuickSearch() {
        const searchInput = document.getElementById('osmSearchInput');
        const searchTerm = searchInput.value || getBusinessNameFromOCR();
        
        if (!searchTerm) {
            log('‚ö†Ô∏è No business name to search', 'warning');
            showNotification('Enter a business name or extract from OCR first', 'warning');
            return;
        }
        
        log(`üó∫Ô∏è OSM Quick Search: ${searchTerm}`, 'info');
        
        // Update input if we used OCR
        if (!searchInput.value && searchTerm) {
            searchInput.value = searchTerm;
        }
        
        // Perform search
        performOSMSearch(searchTerm);
    }
    
    function autoDetectBusiness() {
        log('üîç Auto-detecting business from OCR...', 'info');
        
        const businessName = getBusinessNameFromOCR();
        if (businessName) {
            document.getElementById('osmSearchInput').value = businessName;
            log(`‚úÖ Detected: ${businessName}`, 'success');
            showNotification(`Business detected: ${businessName}`, 'success');
            
            // Automatically search
            performOSMSearch(businessName);
        } else {
            log('‚ùå Could not detect business name', 'error');
            showNotification('Could not detect business name from OCR', 'error');
        }
    }
    
    function getBusinessNameFromOCR() {
        const ocrText = document.getElementById('ocrTextContent').textContent;
        if (!ocrText || ocrText === '[no ocr text available]') {
            return '';
        }
        
        // Get first non-empty lines (usually store name is at top)
        const lines = ocrText.split('\n').filter(line => line.trim());
        
        // Common patterns for Turkish receipts
        const skipPatterns = [
            /^fi≈ü$/i,
            /^fatura$/i,
            /^perakende/i,
            /^satƒ±≈ü/i,
            /^mali deƒüer/i,
            /^\d+$/,
            /^tarih/i,
            /^saat/i
        ];
        
        // Find first line that doesn't match skip patterns
        for (const line of lines.slice(0, 5)) {
            const trimmed = line.trim();
            if (trimmed.length > 2 && !skipPatterns.some(p => p.test(trimmed))) {
                // Clean up the name
                return trimmed.replace(/[*#]/g, '').trim();
            }
        }
        
        return lines[0] ? lines[0].trim() : '';
    }
    
    function performOSMSearch(searchTerm) {
        fetch(`/documents/receipts/search-nearby-business/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                store_name: searchTerm,
                location_hint: 'Bodrum, Muƒüla, Turkey'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.businesses && data.businesses.length > 0) {
                log(`‚úÖ Found ${data.businesses.length} businesses`, 'success');
                showBusinessSelector(data.businesses);
            } else {
                log('‚ùå No businesses found', 'warning');
                showNotification('No businesses found. Try a different search.', 'warning');
            }
        })
        .catch(error => {
            log(`‚ùå Search error: ${error.message}`, 'error');
            showNotification('Search failed: ' + error.message, 'error');
        });
    }
    
    // Setup autocomplete for OSM search input
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('osmSearchInput');
        if (searchInput) {
            // Add autocomplete suggestions as user types
            let debounceTimer;
            searchInput.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    if (this.value.length >= 3) {
                        fetchOSMSuggestions(this.value);
                    }
                }, 300);
            });
        }
    });
    
    function fetchOSMSuggestions(query) {
        // For now, we'll use the same search endpoint
        // In future, we could add a dedicated suggestions endpoint
        fetch(`/documents/receipts/search-nearby-business/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                store_name: query,
                location_hint: 'Bodrum, Muƒüla, Turkey'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.businesses) {
                showSuggestions(data.businesses.slice(0, 5));
            }
        })
        .catch(error => {
            console.error('Suggestion fetch error:', error);
        });
    }
    
    function showSuggestions(businesses) {
        // Remove existing suggestions
        const existingSuggestions = document.getElementById('osmSuggestions');
        if (existingSuggestions) {
            existingSuggestions.remove();
        }
        
        if (businesses.length === 0) return;
        
        const searchInput = document.getElementById('osmSearchInput');
        const rect = searchInput.getBoundingClientRect();
        
        const suggestions = document.createElement('div');
        suggestions.id = 'osmSuggestions';
        suggestions.style.cssText = `
            position: fixed;
            top: ${rect.bottom + 2}px;
            left: ${rect.left}px;
            width: ${rect.width}px;
            background: #111;
            border: 1px solid var(--cyan);
            border-radius: 3px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,255,255,0.3);
        `;
        
        businesses.forEach(business => {
            const item = document.createElement('div');
            item.style.cssText = `
                padding: 8px;
                color: var(--cyan);
                cursor: pointer;
                border-bottom: 1px solid rgba(0,255,255,0.2);
                transition: background 0.2s;
            `;
            item.innerHTML = `
                <div style="font-weight: bold;">${business.name}</div>
                <div style="font-size: 10px; color: var(--gray); margin-top: 2px;">
                    ${business.formatted_address || business.address || ''}
                </div>
            `;
            item.onmouseover = () => item.style.background = 'rgba(0,255,255,0.1)';
            item.onmouseout = () => item.style.background = '';
            item.onclick = () => {
                searchInput.value = business.name;
                suggestions.remove();
                selectBusiness(business);
            };
            suggestions.appendChild(item);
        });
        
        document.body.appendChild(suggestions);
        
        // Remove suggestions when clicking elsewhere
        document.addEventListener('click', function removeSuggestions(e) {
            if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.remove();
                document.removeEventListener('click', removeSuggestions);
            }
        });
    }
    
    function searchNearbyBusiness() {
        log('üìç Starting nearby business search...', 'info');
        
        // Get current store name from form or OCR text
        const storeNameInput = document.querySelector('input[name="store_name"]');
        let storeName = storeNameInput ? storeNameInput.value : '';
        
        // If no store name in form, try to extract from OCR text
        if (!storeName) {
            const ocrText = document.getElementById('ocrTextContent').textContent;
            // Get first line that might be store name
            const lines = ocrText.split('\n').filter(line => line.trim());
            if (lines.length > 0) {
                storeName = lines[0].trim();
            }
        }
        
        if (!storeName) {
            log('‚ö†Ô∏è No store name found. Please enter a store name first.', 'warning');
            showNotification('Please enter a store name first', 'warning');
            return;
        }
        
        log(`üîç Searching for businesses matching: ${storeName}`, 'info');
        
        // Call OSM search endpoint
        fetch(`/documents/receipts/search-nearby-business/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                store_name: storeName,
                location_hint: 'Bodrum, Muƒüla, Turkey'  // Default location hint
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.businesses && data.businesses.length > 0) {
                log(`‚úÖ Found ${data.businesses.length} nearby businesses`, 'success');
                
                // Show business selection modal
                showBusinessSelector(data.businesses);
            } else {
                log('‚ùå No nearby businesses found', 'warning');
                showNotification('No nearby businesses found. Try manual search.', 'warning');
            }
        })
        .catch(error => {
            log(`‚ùå Search error: ${error.message}`, 'error');
            showNotification('Search failed: ' + error.message, 'error');
        });
    }
    
    function showBusinessSelector(businesses) {
        // Create modal for business selection
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #111;
            border: 2px solid var(--cyan);
            border-radius: 10px;
            padding: 20px;
            z-index: 1000;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0,255,255,0.5);
        `;
        
        modal.innerHTML = `
            <h3 style="color: var(--orange); margin-bottom: 15px;">üìç Select Nearby Business</h3>
            <div style="color: var(--gray); margin-bottom: 15px;">Found ${businesses.length} matching businesses:</div>
        `;
        
        businesses.forEach((business, index) => {
            const businessCard = document.createElement('div');
            businessCard.style.cssText = `
                background: rgba(0,255,255,0.05);
                border: 1px solid var(--cyan);
                border-radius: 5px;
                padding: 10px;
                margin-bottom: 10px;
                cursor: pointer;
                transition: all 0.3s;
            `;
            
            businessCard.innerHTML = `
                <div style="color: var(--green); font-weight: bold;">${business.name || 'Unknown'}</div>
                <div style="color: var(--gray); font-size: 12px; margin-top: 5px;">
                    ${business.formatted_address || business.address || 'No address'}
                </div>
                ${business.phone ? `<div style="color: var(--cyan); font-size: 12px;">üìû ${business.phone}</div>` : ''}
                ${business.distance ? `<div style="color: var(--orange); font-size: 12px;">üìè ${business.distance}m away</div>` : ''}
            `;
            
            businessCard.onmouseover = () => {
                businessCard.style.background = 'rgba(0,255,255,0.1)';
                businessCard.style.transform = 'translateX(5px)';
            };
            
            businessCard.onmouseout = () => {
                businessCard.style.background = 'rgba(0,255,255,0.05)';
                businessCard.style.transform = 'translateX(0)';
            };
            
            businessCard.onclick = () => {
                selectBusiness(business);
                document.body.removeChild(modal);
                document.body.removeChild(overlay);
            };
            
            modal.appendChild(businessCard);
        });
        
        // Add close button
        const closeBtn = document.createElement('button');
        closeBtn.textContent = '‚úñ Close';
        closeBtn.style.cssText = `
            background: var(--red);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        `;
        closeBtn.onclick = () => {
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
        };
        modal.appendChild(closeBtn);
        
        // Add overlay
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 999;
        `;
        overlay.onclick = () => {
            document.body.removeChild(modal);
            document.body.removeChild(overlay);
        };
        
        document.body.appendChild(overlay);
        document.body.appendChild(modal);
    }
    
    function selectBusiness(business) {
        log(`‚úÖ Selected business: ${business.name}`, 'success');
        
        // Fill form fields with business data
        const fields = {
            'store_name': business.name,
            'store_address': business.formatted_address || business.address,
            'store_phone': business.phone,
            'store_website': business.website,
            'store_tax_number': business.tax_number
        };
        
        for (const [fieldName, value] of Object.entries(fields)) {
            if (value) {
                const input = document.querySelector(`input[name="${fieldName}"], textarea[name="${fieldName}"]`);
                if (input) {
                    input.value = value;
                    input.style.background = 'rgba(0,255,0,0.1)';
                    setTimeout(() => {
                        input.style.background = '';
                    }, 2000);
                }
            }
        }
        
        log('üìù Form fields updated with business information', 'success');
        showNotification('Business information applied!', 'success');
    }
</script>
{% endblock %}