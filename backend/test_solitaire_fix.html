<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solitaire Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1e5620; color: white; }
        .card { display: inline-block; margin: 2px; padding: 8px; background: white; color: black; border: 1px solid #ccc; border-radius: 4px; min-width: 30px; text-align: center; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .error { color: #ff4444; }
        .success { color: #44ff44; }
        .info { color: #4444ff; }
    </style>
</head>
<body>
    <h1>Solitaire Card Dealing Issue Test</h1>
    
    <div id="test-results"></div>
    
    <script>
        // Mock backend game state (what Django should be sending)
        const mockGameState = {
            stock: [
                {suit: 'spades', rank: 'A', face_up: false},
                {suit: 'hearts', rank: '2', face_up: false},
                {suit: 'diamonds', rank: '3', face_up: false},
                {suit: 'clubs', rank: '4', face_up: false},
                {suit: 'spades', rank: '5', face_up: false},
                {suit: 'hearts', rank: '6', face_up: false},
                {suit: 'diamonds', rank: '7', face_up: false},
                {suit: 'clubs', rank: '8', face_up: false},
                {suit: 'spades', rank: '9', face_up: false},
                {suit: 'hearts', rank: '10', face_up: false},
                {suit: 'diamonds', rank: 'J', face_up: false},
                {suit: 'clubs', rank: 'Q', face_up: false},
                {suit: 'spades', rank: 'K', face_up: false},
                {suit: 'hearts', rank: 'A', face_up: false},
                {suit: 'diamonds', rank: '2', face_up: false},
                {suit: 'clubs', rank: '3', face_up: false},
                {suit: 'spades', rank: '4', face_up: false},
                {suit: 'hearts', rank: '5', face_up: false},
                {suit: 'diamonds', rank: '6', face_up: false},
                {suit: 'clubs', rank: '7', face_up: false},
                {suit: 'spades', rank: '8', face_up: false},
                {suit: 'hearts', rank: '9', face_up: false},
                {suit: 'diamonds', rank: '10', face_up: false},
                {suit: 'clubs', rank: 'J', face_up: false}
            ],
            waste: [],
            foundations: {
                spades: [],
                hearts: [],
                diamonds: [],
                clubs: []
            },
            tableau: [
                [{suit: 'spades', rank: 'Q', face_up: true}],
                [{suit: 'hearts', rank: 'K', face_up: false}, {suit: 'diamonds', rank: 'A', face_up: true}],
                [{suit: 'clubs', rank: '2', face_up: false}, {suit: 'spades', rank: '3', face_up: false}, {suit: 'hearts', rank: '4', face_up: true}],
                [{suit: 'diamonds', rank: '5', face_up: false}, {suit: 'clubs', rank: '6', face_up: false}, {suit: 'spades', rank: '7', face_up: false}, {suit: 'hearts', rank: '8', face_up: true}],
                [{suit: 'diamonds', rank: '9', face_up: false}, {suit: 'clubs', rank: '10', face_up: false}, {suit: 'spades', rank: 'J', face_up: false}, {suit: 'hearts', rank: 'Q', face_up: false}, {suit: 'diamonds', rank: 'K', face_up: true}],
                [{suit: 'clubs', rank: 'A', face_up: false}, {suit: 'spades', rank: '2', face_up: false}, {suit: 'hearts', rank: '3', face_up: false}, {suit: 'diamonds', rank: '4', face_up: false}, {suit: 'clubs', rank: '5', face_up: false}, {suit: 'spades', rank: '6', face_up: true}],
                [{suit: 'hearts', rank: '7', face_up: false}, {suit: 'diamonds', rank: '8', face_up: false}, {suit: 'clubs', rank: '9', face_up: false}, {suit: 'spades', rank: '10', face_up: false}, {suit: 'hearts', rank: 'J', face_up: false}, {suit: 'diamonds', rank: 'Q', face_up: false}, {suit: 'clubs', rank: 'K', face_up: true}]
            ],
            score: 0,
            moves: 0,
            time: 0,
            is_won: false,
            move_history: [],
            undo_stack: []
        };

        // Test functions
        function runTests() {
            const results = document.getElementById('test-results');
            results.innerHTML = '';
            
            // Test 1: Check if backend game state is valid
            addResult('Test 1: Backend Game State Validation', testBackendGameState(), results);
            
            // Test 2: Check card conversion function
            addResult('Test 2: Card Conversion Function', testCardConversion(), results);
            
            // Test 3: Check game object creation
            addResult('Test 3: Game Object Creation', testGameObjectCreation(), results);
            
            // Test 4: Check card rendering
            addResult('Test 4: Card Rendering', testCardRendering(), results);
        }
        
        function addResult(testName, result, container) {
            const div = document.createElement('div');
            div.className = 'section';
            div.innerHTML = `<h3>${testName}</h3><div class="${result.success ? 'success' : 'error'}">${result.message}</div>${result.details || ''}`;
            container.appendChild(div);
        }
        
        function testBackendGameState() {
            try {
                const stockCount = mockGameState.stock.length;
                const tableauCounts = mockGameState.tableau.map(pile => pile.length);
                const expectedTableauCounts = [1, 2, 3, 4, 5, 6, 7];
                
                if (stockCount !== 24) {
                    return { success: false, message: `Stock should have 24 cards, got ${stockCount}` };
                }
                
                if (JSON.stringify(tableauCounts) !== JSON.stringify(expectedTableauCounts)) {
                    return { success: false, message: `Tableau should have [1,2,3,4,5,6,7] cards, got [${tableauCounts}]` };
                }
                
                return { success: true, message: 'Backend game state is valid!', details: `<div>Stock: ${stockCount} cards, Tableau: [${tableauCounts}]</div>` };
            } catch (error) {
                return { success: false, message: `Error: ${error.message}` };
            }
        }
        
        function testCardConversion() {
            try {
                const suitMap = {
                    'clubs': 3,    // â™£
                    'hearts': 1,   // â™¥
                    'diamonds': 2, // â™¦
                    'spades': 0    // â™ 
                };
                
                function convertCard(card) {
                    if (!card) return null;
                    
                    const suitIndex = typeof card.suit === 'string' ? suitMap[card.suit] : card.suit;
                    const values = { A: 1, J: 11, Q: 12, K: 13 };
                    
                    return {
                        suit: suitIndex,
                        rank: card.rank || 'A',
                        value: card.value || values[card.rank] || parseInt(card.rank) || 1,
                        color: (suitIndex === 1 || suitIndex === 2) ? 'red' : 'black',
                        faceUp: card.face_up === true
                    };
                }
                
                const testCard = {suit: 'hearts', rank: 'K', face_up: true};
                const converted = convertCard(testCard);
                
                if (converted.suit !== 1) return { success: false, message: 'Hearts should convert to suit 1' };
                if (converted.rank !== 'K') return { success: false, message: 'Rank should be preserved' };
                if (converted.color !== 'red') return { success: false, message: 'Hearts should be red' };
                if (converted.faceUp !== true) return { success: false, message: 'Face up status should be preserved' };
                
                return { success: true, message: 'Card conversion working correctly!', details: `<div>Test card: ${JSON.stringify(testCard)} â†’ ${JSON.stringify(converted)}</div>` };
            } catch (error) {
                return { success: false, message: `Error: ${error.message}` };
            }
        }
        
        function testGameObjectCreation() {
            try {
                const suitMap = { 'clubs': 3, 'hearts': 1, 'diamonds': 2, 'spades': 0 };
                const values = { A: 1, J: 11, Q: 12, K: 13 };
                
                function convertCard(card) {
                    if (!card) return null;
                    const suitIndex = typeof card.suit === 'string' ? suitMap[card.suit] : card.suit;
                    return {
                        suit: suitIndex,
                        rank: card.rank || 'A',
                        value: card.value || values[card.rank] || parseInt(card.rank) || 1,
                        color: (suitIndex === 1 || suitIndex === 2) ? 'red' : 'black',
                        faceUp: card.face_up === true
                    };
                }
                
                // Simulate game object creation from backend state
                const game = {
                    stock: mockGameState.stock ? mockGameState.stock.map(convertCard) : [],
                    waste: mockGameState.waste ? mockGameState.waste.map(convertCard) : [],
                    foundations: mockGameState.foundations ? 
                        [
                            mockGameState.foundations.spades ? mockGameState.foundations.spades.map(convertCard) : [],
                            mockGameState.foundations.hearts ? mockGameState.foundations.hearts.map(convertCard) : [],
                            mockGameState.foundations.diamonds ? mockGameState.foundations.diamonds.map(convertCard) : [],
                            mockGameState.foundations.clubs ? mockGameState.foundations.clubs.map(convertCard) : []
                        ] : [[], [], [], []],
                    tableau: mockGameState.tableau ? 
                        mockGameState.tableau.map((pile) => {
                            if (!pile) return [];
                            return pile.map((card) => convertCard(card));
                        }) : [[], [], [], [], [], [], []],
                    score: mockGameState.score || 0,
                    moves: mockGameState.moves || 0,
                };
                
                if (game.stock.length !== 24) return { success: false, message: `Expected 24 stock cards, got ${game.stock.length}` };
                if (game.tableau.length !== 7) return { success: false, message: `Expected 7 tableau piles, got ${game.tableau.length}` };
                
                const tableauCounts = game.tableau.map(pile => pile.length);
                if (JSON.stringify(tableauCounts) !== JSON.stringify([1, 2, 3, 4, 5, 6, 7])) {
                    return { success: false, message: `Wrong tableau layout: [${tableauCounts}]` };
                }
                
                return { success: true, message: 'Game object created successfully!', details: `<div>Stock: ${game.stock.length}, Tableau: [${tableauCounts}], Foundations: [${game.foundations.map(f => f.length)}]</div>` };
            } catch (error) {
                return { success: false, message: `Error: ${error.message}` };
            }
        }
        
        function testCardRendering() {
            try {
                const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
                
                function createCard(card, faceUp) {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'card';
                    
                    const shouldShowFace = faceUp !== undefined ? faceUp : (card && card.faceUp);
                    
                    if (shouldShowFace && card) {
                        cardEl.classList.add('face-up', card.color);
                        cardEl.innerHTML = `${card.rank}${suits[card.suit]}`;
                    } else {
                        cardEl.classList.add('face-down');
                        cardEl.innerHTML = 'ðŸ‚ ';
                    }
                    
                    return cardEl;
                }
                
                // Test rendering a few cards
                const testCards = [
                    {suit: 0, rank: 'A', color: 'black', faceUp: true},
                    {suit: 1, rank: 'K', color: 'red', faceUp: true},
                    {suit: 2, rank: '10', color: 'red', faceUp: false},
                    {suit: 3, rank: 'J', color: 'black', faceUp: false}
                ];
                
                let renderedCards = '';
                testCards.forEach(card => {
                    const cardEl = createCard(card, card.faceUp);
                    renderedCards += cardEl.outerHTML;
                });
                
                return { success: true, message: 'Card rendering working correctly!', details: `<div>Rendered cards: ${renderedCards}</div>` };
            } catch (error) {
                return { success: false, message: `Error: ${error.message}` };
            }
        }
        
        // Run tests when page loads
        window.onload = runTests;
    </script>
</body>
</html>