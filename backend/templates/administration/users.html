{% extends "administration/base_admin.html" %}

{% block title %}User Management - UNIBOS Administration{% endblock %}

{% block admin_content %}
<div class="terminal-header">
    <div class="terminal-title">User Management</div>
    <div class="terminal-controls">
        <button onclick="window.location.href='#'" class="terminal-button success">+ Add New User</button>
    </div>
</div>

<!-- Search and Filter Bar -->
<div class="terminal-section">
    <form method="get" class="filter-form">
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" name="search" placeholder="search users..." value="{{ request.GET.search }}" class="terminal-input" style="flex: 1;">
            
            <select name="dept" class="terminal-select">
                <option value="">all departments</option>
                {% for dept in departments %}
                <option value="{{ dept.id }}" {% if request.GET.dept == dept.id|stringformat:"s" %}selected{% endif %}>
                    {{ dept.name }}
                </option>
                {% endfor %}
            </select>
            
            <select name="role" class="terminal-select">
                <option value="">all roles</option>
                {% for role in roles %}
                <option value="{{ role.id }}" {% if request.GET.role == role.id|stringformat:"s" %}selected{% endif %}>
                    {{ role.name }}
                </option>
                {% endfor %}
            </select>
            
            <button type="submit" class="terminal-button">üîç Filter</button>
            <a href="{% url 'administration:users' %}" class="terminal-button">Clear</a>
        </div>
    </form>
</div>

<!-- User Statistics -->
<div class="stat-grid">
    <div class="stat-card">
        <div class="stat-number">{{ users.count }}</div>
        <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ users|dictsort:"last_login"|slice:":7"|length }}</div>
        <div class="stat-label">Active This Week</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ users.filter.is_superuser|length|default:0 }}</div>
        <div class="stat-label">Administrators</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ users.filter.is_active|length|default:0 }}</div>
        <div class="stat-label">Active Users</div>
    </div>
</div>

<!-- Users Table -->
<div class="terminal-section">
    <div class="section-header">
        <h3>User List</h3>
        <div style="display: flex; gap: 10px;">
            <button class="terminal-button" onclick="exportUsers()">üì• Export</button>
            <button class="terminal-button" onclick="importUsers()">üì§ Import</button>
        </div>
    </div>

    <div class="terminal-table-container">
        <table class="terminal-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes()"></th>
                    <th>Username</th>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>Roles</th>
                    <th>Departments</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>
                        {% if not user.is_superuser and user != request.user %}
                        <input type="checkbox" class="user-checkbox" value="{{ user.id }}">
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ user.username }}</strong>
                        {% if user.is_superuser %}
                        <span class="badge badge-danger">Super Admin</span>
                        {% endif %}
                    </td>
                    <td>{{ user.get_full_name|default:"-" }}</td>
                    <td>{{ user.email|default:"-" }}</td>
                    <td>
                        {% for user_role in user.user_roles.all %}
                        <span class="badge badge-primary">{{ user_role.role.name }}</span>
                        {% empty %}
                        <span class="text-muted">No roles</span>
                        {% endfor %}
                    </td>
                    <td>
                        {% for dept in user.departments.all %}
                        <span class="badge badge-info">{{ dept.name }}</span>
                        {% empty %}
                        <span class="text-muted">-</span>
                        {% endfor %}
                    </td>
                    <td>
                        {% if user.is_active %}
                        <span class="badge badge-success">Active</span>
                        {% else %}
                        <span class="badge badge-danger">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.last_login %}
                        {{ user.last_login|timesince }} ago
                        {% else %}
                        Never
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'administration:user_detail' user.id %}" class="action-link">View</a>
                        <a href="{% url 'administration:user_detail' user.id %}" class="action-link">Edit</a>
                        {% if not user.is_superuser and user != request.user %}
                        <a href="#" onclick="toggleUserStatus({{ user.id }})" class="action-link">
                            {% if user.is_active %}Deactivate{% else %}Activate{% endif %}
                        </a>
                        <a href="#" onclick="deleteUser({{ user.id }}, '{{ user.username }}')" class="action-link delete-link">Delete</a>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center">No users found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Quick Actions -->
<div class="section">
    <h2>quick actions</h2>
    <div class="button-group">
        <button class="btn-secondary" onclick="syncWithLDAP()">üîÑ sync with ldap</button>
        <button class="btn-secondary" onclick="sendBulkEmail()">üìß send bulk email</button>
        <button class="btn-warning" onclick="bulkDeactivate()">‚ö†Ô∏è bulk deactivate</button>
        <button class="btn-primary" onclick="bulkActivate()">‚úÖ bulk activate</button>
        <button class="btn-danger" onclick="bulkDelete()">üóëÔ∏è bulk delete</button>
    </div>
</div>

<!-- Custom Confirmation Popup -->
<div id="confirmPopup" class="confirm-popup" style="display: none;">
    <div class="popup-content">
        <div class="popup-header">
            <span class="popup-icon">‚ö†Ô∏è</span>
            <h3 id="popupTitle">confirm action</h3>
        </div>
        <div class="popup-body">
            <p id="popupMessage">are you sure?</p>
        </div>
        <div class="popup-footer">
            <button class="btn-cancel" onclick="closePopup()">cancel</button>
            <button class="btn-confirm" id="confirmButton">confirm</button>
        </div>
    </div>
</div>

<style>
.confirm-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.popup-content {
    background: #1a1a1a;
    border: 2px solid #00ff00;
    border-radius: 0;
    padding: 0;
    width: 400px;
    font-family: 'Courier New', monospace;
    box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
}

.popup-header {
    background: #0a0a0a;
    padding: 15px;
    border-bottom: 1px solid #00ff00;
    text-align: center;
}

.popup-icon {
    font-size: 24px;
    display: block;
    margin-bottom: 10px;
}

.popup-header h3 {
    color: #00ff00;
    margin: 0;
    font-size: 16px;
    text-transform: lowercase;
}

.popup-body {
    padding: 20px;
    text-align: center;
}

.popup-body p {
    color: #00ff00;
    margin: 0;
    font-size: 14px;
}

.popup-footer {
    padding: 15px;
    border-top: 1px solid #00ff00;
    display: flex;
    justify-content: space-around;
}

.btn-cancel, .btn-confirm {
    padding: 8px 20px;
    border: 1px solid #00ff00;
    background: #0a0a0a;
    color: #00ff00;
    cursor: pointer;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    text-transform: lowercase;
}

.btn-cancel:hover {
    background: #1a1a1a;
}

.btn-confirm {
    background: #ff0000;
    border-color: #ff0000;
    color: #ffffff;
}

.btn-confirm:hover {
    background: #cc0000;
}

.delete-link {
    color: #ff6b6b !important;
}

.delete-link:hover {
    color: #ff0000 !important;
}

.user-checkbox {
    cursor: pointer;
}
</style>

<script>
let currentAction = null;
let currentUserId = null;

function showPopup(title, message, action) {
    currentAction = action;
    document.getElementById('popupTitle').textContent = title;
    document.getElementById('popupMessage').textContent = message;
    document.getElementById('confirmPopup').style.display = 'flex';
    
    // Set confirm button action
    document.getElementById('confirmButton').onclick = function() {
        if (currentAction) {
            currentAction();
        }
        closePopup();
    };
}

function closePopup() {
    document.getElementById('confirmPopup').style.display = 'none';
    currentAction = null;
    currentUserId = null;
}

function toggleUserStatus(userId) {
    showPopup(
        'confirm status change',
        'are you sure you want to change this user\'s status?',
        function() {
            fetch(`/administration/users/${userId}/toggle-status/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
        }
    );
}

function deleteUser(userId, username) {
    showPopup(
        '‚ö†Ô∏è confirm deletion',
        `are you sure you want to permanently delete user "${username}"? this action cannot be undone!`,
        function() {
            fetch(`/administration/users/${userId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error deleting user');
                }
            });
        }
    );
}

function toggleAllCheckboxes() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
}

function getSelectedUsers() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function bulkDelete() {
    const selectedUsers = getSelectedUsers();
    if (selectedUsers.length === 0) {
        alert('please select users to delete');
        return;
    }
    
    showPopup(
        '‚ö†Ô∏è confirm bulk deletion',
        `are you sure you want to permanently delete ${selectedUsers.length} selected users? this action cannot be undone!`,
        function() {
            fetch('/administration/users/bulk-delete/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_ids: selectedUsers })
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error deleting users');
                }
            });
        }
    );
}

function bulkDeactivate() {
    const selectedUsers = getSelectedUsers();
    if (selectedUsers.length === 0) {
        alert('please select users to deactivate');
        return;
    }
    
    showPopup(
        'confirm bulk deactivation',
        `are you sure you want to deactivate ${selectedUsers.length} selected users?`,
        function() {
            fetch('/administration/users/bulk-status/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_ids: selectedUsers, active: false })
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
        }
    );
}

function bulkActivate() {
    const selectedUsers = getSelectedUsers();
    if (selectedUsers.length === 0) {
        alert('please select users to activate');
        return;
    }
    
    showPopup(
        'confirm bulk activation',
        `are you sure you want to activate ${selectedUsers.length} selected users?`,
        function() {
            fetch('/administration/users/bulk-status/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_ids: selectedUsers, active: true })
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
        }
    );
}

function exportUsers() {
    console.log('Exporting users...');
    window.location.href = '{% url "administration:users" %}?export=csv';
}

function importUsers() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            console.log('Importing:', file.name);
            // Implement import functionality
        }
    };
    input.click();
}

function syncWithLDAP() {
    if (confirm('Sync users with LDAP directory?')) {
        console.log('Syncing with LDAP...');
        // Implement LDAP sync
    }
}

function sendBulkEmail() {
    console.log('Opening bulk email dialog...');
    // Implement bulk email functionality
}

function bulkDeactivate() {
    if (confirm('This will deactivate multiple users. Continue?')) {
        console.log('Bulk deactivating...');
        // Implement bulk deactivate
    }
}

function bulkActivate() {
    if (confirm('This will activate multiple users. Continue?')) {
        console.log('Bulk activating...');
        // Implement bulk activate
    }
}
</script>
{% endblock %}