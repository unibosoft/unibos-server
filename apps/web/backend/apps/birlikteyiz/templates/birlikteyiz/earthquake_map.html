{% extends 'birlikteyiz/base_birlikteyiz.html' %}

{% block title %}deprem haritasƒ± - birlikteyiz - unibos{% endblock %}

{% block extra_css %}
{{ block.super }}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
<style>
/* Override Leaflet styles for dark theme */
.leaflet-popup-content-wrapper {
    background: #1a1a1a;
    color: var(--green);
    border: 1px solid var(--green);
    font-family: 'Courier New', monospace;
    font-size: 12px;
}

.leaflet-popup-tip {
    background: #1a1a1a;
    border: 1px solid var(--green);
}

.leaflet-container {
    background: #0a0a0a;
}

.leaflet-control-zoom a {
    background: #1a1a1a;
    color: var(--green);
    border: 1px solid var(--green);
}

.leaflet-control-zoom a:hover {
    background: #2a2a2a;
}

.leaflet-bar {
    border: 1px solid var(--green);
}

.leaflet-control-attribution {
    background: rgba(26, 26, 26, 0.8);
    color: var(--green);
    font-size: 10px;
}

.leaflet-control-attribution a {
    color: var(--cyan);
}
</style>
{% endblock %}

{% block birlikteyiz_content %}

<!-- Map Controls -->
<div class="section" style="margin-bottom: 10px;">
    <div class="section-header">
        <h2>üó∫Ô∏è deprem haritasƒ±</h2>
        <div class="section-controls">
            <a href="{% url 'birlikteyiz:dashboard' %}" class="btn-secondary">‚Üê geri d√∂n</a>
            <a href="{% url 'birlikteyiz:earthquake_list' %}" class="btn-secondary">liste g√∂r√ºn√ºm√º</a>
        </div>
    </div>
</div>

<!-- Statistics Bar -->
<div class="stats-grid" style="margin-bottom: 20px;">
    <div class="stat-card">
        <div class="stat-value">{{ total_earthquakes }}</div>
        <div class="stat-label">toplam deprem</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: #ff4444;">{{ major_count }}</div>
        <div class="stat-label">b√ºy√ºk (‚â•5.0)</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: var(--orange);">{{ moderate_count }}</div>
        <div class="stat-label">orta (4.0-5.0)</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" style="color: var(--yellow);">{{ minor_count }}</div>
        <div class="stat-label">k√º√ß√ºk (3.0-4.0)</div>
    </div>
</div>

<!-- Filters -->
<div class="section" style="margin-bottom: 20px;">
    <form method="get" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <div style="display: flex; gap: 8px; align-items: center;">
            <label style="color: var(--green); font-size: 12px;">zaman aralƒ±ƒüƒ±:</label>
            <select name="days" style="background: #0a0a0a; border: 1px solid var(--green); color: var(--green); padding: 5px 10px; font-family: 'Courier New', monospace; font-size: 12px;">
                <option value="1" {% if filter_days == 1 %}selected{% endif %}>son 24 saat</option>
                <option value="3" {% if filter_days == 3 %}selected{% endif %}>son 3 g√ºn</option>
                <option value="7" {% if filter_days == 7 %}selected{% endif %}>son 7 g√ºn</option>
                <option value="14" {% if filter_days == 14 %}selected{% endif %}>son 14 g√ºn</option>
                <option value="30" {% if filter_days == 30 %}selected{% endif %}>son 30 g√ºn</option>
            </select>
        </div>

        <div style="display: flex; gap: 8px; align-items: center;">
            <label style="color: var(--green); font-size: 12px;">minimum b√ºy√ºkl√ºk:</label>
            <select name="magnitude_min" style="background: #0a0a0a; border: 1px solid var(--green); color: var(--green); padding: 5px 10px; font-family: 'Courier New', monospace; font-size: 12px;">
                <option value="2.0" {% if filter_magnitude_min == 2.0 %}selected{% endif %}>2.0+</option>
                <option value="2.5" {% if filter_magnitude_min == 2.5 %}selected{% endif %}>2.5+</option>
                <option value="3.0" {% if filter_magnitude_min == 3.0 %}selected{% endif %}>3.0+</option>
                <option value="4.0" {% if filter_magnitude_min == 4.0 %}selected{% endif %}>4.0+</option>
                <option value="5.0" {% if filter_magnitude_min == 5.0 %}selected{% endif %}>5.0+</option>
            </select>
        </div>

        <button type="submit" class="btn-primary">filtrele</button>
    </form>
</div>

<!-- Map Container -->
<div class="section">
    <div id="earthquake-map" style="height: 600px; width: 100%; border: 2px solid var(--green); background: #0a0a0a;"></div>
</div>

<!-- Legend -->
<div class="section" style="margin-top: 20px;">
    <div class="section-header">
        <h3>g√∂sterge</h3>
    </div>
    <div style="display: flex; gap: 20px; flex-wrap: wrap; padding: 15px;">
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 20px; height: 20px; border-radius: 50%; background: #ff4444; border: 2px solid #fff;"></div>
            <span style="color: var(--green); font-size: 12px;">b√ºy√ºk (‚â•5.0)</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 16px; height: 16px; border-radius: 50%; background: var(--orange); border: 2px solid #fff;"></div>
            <span style="color: var(--green); font-size: 12px;">orta (4.0-5.0)</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--yellow); border: 2px solid #fff;"></div>
            <span style="color: var(--green); font-size: 12px;">k√º√ß√ºk (3.0-4.0)</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--green); border: 2px solid #fff;"></div>
            <span style="color: var(--green); font-size: 12px;">√ßok k√º√ß√ºk (<3.0)</span>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<script>
// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing earthquake map...');

    // Earthquake data from Django
    const earthquakes = {{ earthquake_data_json|safe }};
    console.log('Loaded earthquakes:', earthquakes.length);

    // Check if Leaflet is loaded
    if (typeof L === 'undefined') {
        console.error('Leaflet library not loaded!');
        return;
    }

    // Initialize map centered on Turkey
    const map = L.map('earthquake-map', {
        preferCanvas: true,  // Better performance for many markers
    }).setView([39.0, 35.0], 6);

    console.log('Map initialized');

    // Add dark tile layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    console.log('Tile layer added');

    // Function to get marker color and size based on magnitude
    function getMarkerStyle(magnitude) {
    let color, radius;

    if (magnitude >= 5.0) {
        color = '#ff4444';
        radius = 10;
    } else if (magnitude >= 4.0) {
        color = '#ff8c00';  // orange
        radius = 8;
    } else if (magnitude >= 3.0) {
        color = '#ffff00';  // yellow
        radius = 6;
    } else {
        color = '#00ff00';  // green
        radius = 4;
    }

        return { color, radius };
    }

    // Add earthquake markers
    earthquakes.forEach(eq => {
    const style = getMarkerStyle(eq.magnitude);

    const marker = L.circleMarker([eq.lat, eq.lon], {
        radius: style.radius,
        fillColor: style.color,
        color: '#ffffff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.7
    }).addTo(map);

    // Popup content
    const popupContent = `
        <div style="padding: 5px;">
            <div style="font-weight: bold; font-size: 14px; color: ${style.color}; margin-bottom: 5px;">
                M${eq.magnitude}
            </div>
            <div style="margin-bottom: 3px;">
                <strong>lokasyon:</strong> ${eq.location}
            </div>
            ${eq.city ? `<div style="margin-bottom: 3px;"><strong>≈üehir:</strong> ${eq.city}</div>` : ''}
            <div style="margin-bottom: 3px;">
                <strong>derinlik:</strong> ${eq.depth} km
            </div>
            <div style="margin-bottom: 3px;">
                <strong>zaman:</strong> ${eq.occurred_at}
            </div>
            <div style="margin-bottom: 3px;">
                <strong>kaynak:</strong> ${eq.source}
            </div>
            <div style="font-size: 10px; color: var(--gray); margin-top: 5px;">
                ${eq.time_ago}
            </div>
        </div>
    `;

    marker.bindPopup(popupContent);

    // Hover effect
    marker.on('mouseover', function(e) {
        this.setStyle({
            fillOpacity: 1,
            weight: 3
        });
    });

    marker.on('mouseout', function(e) {
        this.setStyle({
            fillOpacity: 0.7,
            weight: 2
        });
        });
    });

    console.log('Added', earthquakes.length, 'markers to map');

    // Add scale control
    L.control.scale({
        imperial: false,
        metric: true
    }).addTo(map);

    // Auto-fit bounds if there are earthquakes
    if (earthquakes.length > 0) {
        const bounds = L.latLngBounds(earthquakes.map(eq => [eq.lat, eq.lon]));
        map.fitBounds(bounds, { padding: [50, 50] });
        console.log('Map bounds fitted to earthquake locations');
    }

    console.log('Earthquake map initialization complete');
});
</script>
{% endblock %}
