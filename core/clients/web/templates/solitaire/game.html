{% extends "web_ui/base_with_header.html" %}

{% block title %}solitaire - unibos{% endblock %}

{% block module_name %}solitaire{% endblock %}

{% block extra_css %}
<style>
    /* Solitaire Game Styles */
    .solitaire-container {
        width: 100%;
        height: calc(100vh - 80px);
        background: #2d5a2d;
        background-image: radial-gradient(circle at 50% 50%, #3a6b3a, #1e4220);
        position: relative;
        overflow: hidden;
        user-select: none;
    }
    
    .game-board {
        position: relative;
        width: 100%;
        max-width: 1200px;
        height: 100%;
        margin: 0 auto;
        padding: 20px;
    }
    
    /* Card Styles */
    .card {
        width: 80px;
        height: 112px;
        border-radius: 8px;
        position: absolute;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        font-family: 'JetBrains Mono', monospace;
    }
    
    .card.face-up {
        background: white;
        border: 1px solid #333;
    }
    
    .card.face-down {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: 2px solid #4c1d95;
        position: relative;
        box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.3);
    }
    
    .card.face-down::after {
        content: 'ðŸ¦„';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 36px;
        opacity: 0.5;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
    
    .card.selected {
        box-shadow: 0 0 20px #ffd700, 0 4px 8px rgba(0,0,0,0.4);
        transform: translateY(-5px);
    }
    
    .card-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        height: 100%;
        padding: 8px;
    }
    
    .card-rank {
        font-size: 20px;
        font-weight: bold;
        line-height: 1;
    }
    
    .card-suit {
        font-size: 32px;
        line-height: 1;
    }
    
    .card.red .card-rank,
    .card.red .card-suit {
        color: #d32f2f;
    }
    
    .card.black .card-rank,
    .card.black .card-suit {
        color: #000;
    }
    
    /* Pile Styles */
    .pile {
        position: absolute;
        width: 80px;
        height: 112px;
    }
    
    .pile.empty {
        border: 2px dashed rgba(255,255,255,0.3);
        border-radius: 8px;
        background: rgba(0,0,0,0.1);
    }
    
    .pile.foundation.empty::after {
        content: attr(data-suit);
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 40px;
        color: rgba(255,255,255,0.2);
    }
    
    .pile.tableau.empty::after {
        content: 'K';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 30px;
        color: rgba(255,255,255,0.2);
        font-weight: bold;
    }
    
    /* Stock Pile */
    #stock-pile {
        top: 20px;
        left: 20px;
    }
    
    #stock-pile.empty::after {
        content: 'â™»';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 40px;
        color: rgba(255,255,255,0.3);
    }
    
    /* Waste Pile */
    #waste-pile {
        top: 20px;
        left: 120px;
    }
    
    /* Foundation Piles */
    .foundation-area {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 20px;
    }
    
    /* Tableau Area */
    .tableau-area {
        position: absolute;
        top: 160px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }
    
    .tableau-pile {
        position: relative;
        flex: 1;
        min-height: 400px;
    }
    
    .tableau-pile .card {
        position: absolute;
        left: 0;
    }
    
    /* Controls */
    .game-controls {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        background: rgba(0,0,0,0.5);
        padding: 10px;
        border-radius: 8px;
    }
    
    .game-btn {
        padding: 8px 16px;
        background: var(--orange);
        color: black;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-family: 'JetBrains Mono', monospace;
        font-weight: bold;
        transition: all 0.2s;
    }
    
    .game-btn:hover {
        background: var(--orange-bright);
        transform: translateY(-2px);
    }
    
    /* Stats Display */
    .game-stats {
        position: absolute;
        top: 10px;
        right: 20px;
        background: rgba(0,0,0,0.5);
        color: white;
        padding: 10px;
        border-radius: 8px;
        font-family: 'JetBrains Mono', monospace;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin: 5px 0;
    }
    
    /* Lock Screen */
    .lock-screen {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .lock-screen.active {
        display: flex;
    }
    
    .lock-box {
        background: var(--bg-dark);
        border: 2px solid var(--orange);
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        min-width: 400px;
    }
    
    .lock-icon {
        font-size: 48px;
        margin-bottom: 20px;
    }
    
    .lock-input {
        width: 100%;
        padding: 10px;
        background: var(--bg-black);
        border: 1px solid var(--orange);
        border-radius: 4px;
        color: white;
        font-family: 'JetBrains Mono', monospace;
        text-align: center;
        font-size: 18px;
        letter-spacing: 4px;
    }
    
    .lock-message {
        color: var(--orange);
        margin-top: 10px;
        min-height: 20px;
    }
    
    /* Win Screen */
    .win-screen {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.8);
        display: none;
        align-items: center;
        justify-content: center;
    }
    
    .win-screen.active {
        display: flex;
    }
    
    .win-message {
        font-size: 48px;
        color: gold;
        text-shadow: 0 0 20px gold;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .card {
            width: 60px;
            height: 84px;
        }
        
        .card-rank {
            font-size: 16px;
        }
        
        .card-suit {
            font-size: 24px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="solitaire-container">
    <div class="game-board" id="game-board">
        <!-- Controls -->
        <div class="game-controls">
            <button class="game-btn" onclick="drawCard()">draw</button>
            <button class="game-btn" onclick="autoMove()">auto</button>
            <button class="game-btn" onclick="undoMove()">undo</button>
            <button class="game-btn" onclick="newGame()">new</button>
            <button class="game-btn" onclick="toggleFullscreen()">fullscreen</button>
        </div>
        
        <!-- Stats -->
        <div class="game-stats">
            <div class="stat-item">
                <span>moves:</span>
                <span id="moves">0</span>
            </div>
            <div class="stat-item">
                <span>score:</span>
                <span id="score">0</span>
            </div>
            <div class="stat-item">
                <span>time:</span>
                <span id="timer">00:00</span>
            </div>
        </div>
        
        <!-- Stock and Waste -->
        <div id="stock-pile" class="pile stock" onclick="drawCard()"></div>
        <div id="waste-pile" class="pile waste"></div>
        
        <!-- Foundations -->
        <div class="foundation-area">
            <div class="pile foundation empty" data-suit="â™ " data-foundation="0"></div>
            <div class="pile foundation empty" data-suit="â™¥" data-foundation="1"></div>
            <div class="pile foundation empty" data-suit="â™¦" data-foundation="2"></div>
            <div class="pile foundation empty" data-suit="â™£" data-foundation="3"></div>
        </div>
        
        <!-- Tableau -->
        <div class="tableau-area">
            {% for i in '0123456' %}
            <div class="tableau-pile" data-tableau="{{ i }}">
                <div class="pile tableau empty"></div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Win Screen -->
    <div class="win-screen" id="win-screen">
        <div class="win-message">
            ðŸŽ‰ CONGRATULATIONS! ðŸŽ‰
        </div>
    </div>
</div>

<!-- Lock Screen -->
<div class="lock-screen" id="lock-screen">
    <div class="lock-box">
        <div class="lock-icon">ðŸ”’</div>
        <h3 style="color: var(--orange); margin-bottom: 20px;">screen locked</h3>
        <input type="password" 
               class="lock-input" 
               id="lock-password" 
               placeholder="enter password"
               maxlength="20">
        <div class="lock-message" id="lock-message"></div>
    </div>
</div>

<script>
// Game State
let sessionId = '{{ session_id }}';
let gameState = {{ game_state|safe }};
let selectedCards = [];
let selectedFrom = null;
let gameTime = 0;
let timerInterval = null;
let isLocked = {{ is_locked|lower }};

// Card Suits and Ranks
const SUITS = {
    'spades': 'â™ ',
    'hearts': 'â™¥', 
    'diamonds': 'â™¦',
    'clubs': 'â™£'
};

const SUIT_ORDER = ['spades', 'hearts', 'diamonds', 'clubs'];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    if (isLocked) {
        showLockScreen();
    } else {
        initGame();
    }
    
    // Handle password input
    document.getElementById('lock-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            checkPassword();
        }
    });
});

function initGame() {
    renderGame();
    startTimer();
    
    // Set up minimize detection
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // Page minimized - lock the game
            lockGame();
        }
    });
}

function renderGame() {
    // Clear board
    document.querySelectorAll('.card').forEach(c => c.remove());
    
    // Render stock
    renderStock();
    
    // Render waste
    renderWaste();
    
    // Render foundations
    renderFoundations();
    
    // Render tableau
    renderTableau();
    
    // Update stats
    updateStats();
}

function renderStock() {
    const pile = document.getElementById('stock-pile');
    pile.innerHTML = '';
    
    if (gameState.stock && gameState.stock.length > 0) {
        pile.classList.remove('empty');
        
        // Show stock count
        const card = createCardElement(null, false);
        card.innerHTML = `<div style="color: white; font-size: 20px; text-align: center; line-height: 112px;">${gameState.stock.length}</div>`;
        pile.appendChild(card);
    } else {
        pile.classList.add('empty');
    }
}

function renderWaste() {
    const pile = document.getElementById('waste-pile');
    pile.innerHTML = '';
    
    if (gameState.waste && gameState.waste.length > 0) {
        // Show last 3 cards spread
        const cardsToShow = gameState.waste.slice(-3);
        cardsToShow.forEach((card, index) => {
            const cardEl = createCardElement(card, true);
            cardEl.style.left = `${index * 20}px`;
            cardEl.onclick = () => selectCard('waste', 0);
            pile.appendChild(cardEl);
        });
    }
}

function renderFoundations() {
    const foundations = document.querySelectorAll('.foundation');
    SUIT_ORDER.forEach((suit, index) => {
        const pile = foundations[index];
        const cards = gameState.foundations[suit] || [];
        
        pile.innerHTML = '';
        pile.setAttribute('data-suit', SUITS[suit]);
        
        if (cards.length > 0) {
            pile.classList.remove('empty');
            const topCard = cards[cards.length - 1];
            const cardEl = createCardElement(topCard, true);
            cardEl.onclick = () => selectCard('foundation', index);
            pile.appendChild(cardEl);
        } else {
            pile.classList.add('empty');
        }
        
        pile.ondrop = (e) => handleDrop(e, 'foundation', index);
        pile.ondragover = (e) => e.preventDefault();
    });
}

function renderTableau() {
    for (let i = 0; i < 7; i++) {
        const pileContainer = document.querySelector(`[data-tableau="${i}"]`);
        const pile = gameState.tableau[i] || [];
        
        pileContainer.innerHTML = '';
        
        if (pile.length === 0) {
            const emptyPile = document.createElement('div');
            emptyPile.className = 'pile tableau empty';
            pileContainer.appendChild(emptyPile);
        } else {
            pile.forEach((card, cardIndex) => {
                const cardEl = createCardElement(card, card.face_up);
                cardEl.style.top = `${cardIndex * 25}px`;
                
                if (card.face_up) {
                    cardEl.onclick = () => selectCard('tableau', i, cardIndex);
                    cardEl.draggable = true;
                    cardEl.ondragstart = (e) => handleDragStart(e, 'tableau', i, cardIndex);
                }
                
                pileContainer.appendChild(cardEl);
            });
        }
        
        pileContainer.ondrop = (e) => handleDrop(e, 'tableau', i);
        pileContainer.ondragover = (e) => e.preventDefault();
    }
}

function createCardElement(card, faceUp) {
    const cardEl = document.createElement('div');
    cardEl.className = 'card';
    
    if (!card || !faceUp) {
        cardEl.classList.add('face-down');
    } else {
        cardEl.classList.add('face-up');
        const color = (card.suit === 'hearts' || card.suit === 'diamonds') ? 'red' : 'black';
        cardEl.classList.add(color);
        
        cardEl.innerHTML = `
            <div class="card-content">
                <div class="card-rank">${card.rank}</div>
                <div class="card-suit">${SUITS[card.suit]}</div>
                <div class="card-rank">${card.rank}</div>
            </div>
        `;
    }
    
    return cardEl;
}

function selectCard(pileType, pileIndex, cardIndex) {
    // Send select request
    apiCall('select', {
        pile_type: pileType,
        pile_index: pileIndex,
        card_index: cardIndex !== undefined ? cardIndex : -1
    });
}

function handleDragStart(e, pileType, pileIndex, cardIndex) {
    selectCard(pileType, pileIndex, cardIndex);
    e.dataTransfer.effectAllowed = 'move';
}

function handleDrop(e, pileType, pileIndex) {
    e.preventDefault();
    apiCall('move', {
        pile_type: pileType,
        pile_index: pileIndex
    });
}

function drawCard() {
    apiCall('draw', {});
}

function autoMove() {
    apiCall('auto', {});
}

function undoMove() {
    apiCall('undo', {});
}

function newGame() {
    if (confirm('Start a new game?')) {
        apiCall('new_game', {});
        gameTime = 0;
    }
}

function apiCall(action, data) {
    data.session_id = sessionId;
    data.time = gameTime;
    
    fetch(`/solitaire/api/${action}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            gameState = result.game_state;
            renderGame();
            
            if (gameState.is_won) {
                showWinScreen();
            }
        } else if (result.error) {
            console.error(result.error);
        }
    })
    .catch(error => console.error('API Error:', error));
}

function updateStats() {
    document.getElementById('moves').textContent = gameState.moves || 0;
    document.getElementById('score').textContent = gameState.score || 0;
}

function startTimer() {
    gameTime = gameState.time || 0;
    
    timerInterval = setInterval(() => {
        gameTime++;
        const minutes = Math.floor(gameTime / 60);
        const seconds = gameTime % 60;
        document.getElementById('timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function lockGame() {
    // Generate random 4-digit password
    const password = Math.floor(1000 + Math.random() * 9000).toString();
    
    // Show password briefly
    alert(`Locking screen. Password: ${password}`);
    
    // Send lock request
    apiCall('lock', { password: password });
    
    // Show lock screen
    showLockScreen();
}

function showLockScreen() {
    document.getElementById('lock-screen').classList.add('active');
    document.getElementById('lock-password').focus();
}

function checkPassword() {
    const password = document.getElementById('lock-password').value;
    
    fetch('/solitaire/api/unlock/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            session_id: sessionId,
            password: password
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            document.getElementById('lock-screen').classList.remove('active');
            document.getElementById('lock-password').value = '';
            document.getElementById('lock-message').textContent = '';
            isLocked = false;
            if (!timerInterval) {
                initGame();
            }
        } else {
            document.getElementById('lock-message').textContent = 'incorrect password';
            document.getElementById('lock-password').value = '';
        }
    });
}

function showWinScreen() {
    document.getElementById('win-screen').classList.add('active');
    setTimeout(() => {
        document.getElementById('win-screen').classList.remove('active');
    }, 5000);
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (isLocked) return;
    
    switch(e.key) {
        case 'd':
        case 'D':
            drawCard();
            break;
        case 'a':
        case 'A':
            autoMove();
            break;
        case 'u':
        case 'U':
            undoMove();
            break;
        case 'n':
        case 'N':
            newGame();
            break;
        case 'F11':
            e.preventDefault();
            toggleFullscreen();
            break;
    }
});
</script>
{% endblock %}