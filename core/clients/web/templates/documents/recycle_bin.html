{% extends 'web_ui/base.html' %}

{% block title %}recycle bin - documents{% endblock %}

{% block header_title %}unibos{% endblock %}
{% block module_name %}documents{% endblock %}

{% block content %}
<style>
    .recycle-container {
        display: grid;
        gap: 20px;
    }
    
    .recycle-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .recycle-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .stat-box {
        background: var(--bg-dark);
        border: 1px solid var(--dark-gray);
        border-radius: 5px;
        padding: 10px 20px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 24px;
        color: var(--orange);
        font-weight: bold;
    }
    
    .stat-label {
        color: var(--gray);
        font-size: 12px;
        text-transform: lowercase;
        margin-top: 5px;
    }
    
    .deletion-group {
        background: var(--bg-dark);
        border: 1px solid var(--dark-gray);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--dark-gray);
    }
    
    .group-date {
        color: var(--orange);
        font-weight: bold;
    }
    
    .group-count {
        color: var(--gray);
        font-size: 12px;
    }
    
    .deleted-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        background: #000;
        border: 1px solid var(--dark-gray);
        border-radius: 3px;
        transition: all 0.3s;
    }
    
    .deleted-item:hover {
        border-color: var(--orange);
        background: rgba(255, 140, 0, 0.05);
    }
    
    .deleted-item.selected {
        border-color: var(--orange);
        background: rgba(255, 140, 0, 0.1);
    }
    
    .item-checkbox {
        margin-right: 10px;
    }
    
    .item-info {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .item-thumbnail {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 3px;
        border: 1px solid var(--dark-gray);
    }
    
    .item-details {
        flex: 1;
    }
    
    .item-name {
        color: var(--cyan);
        font-size: 14px;
        margin-bottom: 3px;
    }
    
    .item-meta {
        color: var(--gray);
        font-size: 11px;
    }
    
    .item-countdown {
        color: var(--yellow);
        font-size: 11px;
        margin-left: 10px;
    }
    
    .item-countdown.urgent {
        color: var(--red);
        font-weight: bold;
    }
    
    .item-actions {
        display: flex;
        gap: 5px;
    }
    
    .bulk-actions {
        display: none;
        background: var(--bg-dark);
        border: 1px solid var(--orange);
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 15px;
        align-items: center;
        gap: 10px;
    }
    
    .bulk-actions.show {
        display: flex;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--gray);
    }
    
    .empty-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    .warning-box {
        background: rgba(255, 0, 0, 0.1);
        border: 1px solid var(--red);
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 20px;
        color: var(--yellow);
        font-size: 12px;
    }
</style>

<div class="content-box">
    <div class="recycle-header">
        <h1 class="content-title">üóëÔ∏è recycle bin</h1>
        <div>
            <button class="btn btn-secondary" onclick="window.history.back()">‚Üê back</button>
            {% if total_count > 0 %}
            <button class="btn" onclick="emptyRecycleBin()" style="background: var(--red); color: white;">
                üóëÔ∏è empty all
            </button>
            {% endif %}
        </div>
    </div>
    
    {% if total_count > 0 %}
    <div class="warning-box">
        ‚ö†Ô∏è Documents in the recycle bin will be permanently deleted after 30 days. 
        Restore them before it's too late!
    </div>
    {% endif %}
    
    <div class="recycle-stats">
        <div class="stat-box">
            <div class="stat-value">{{ total_count }}</div>
            <div class="stat-label">total documents</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">{{ deletion_groups|length }}</div>
            <div class="stat-label">deletion batches</div>
        </div>
    </div>
</div>

<div class="content-box">
    {% if total_count > 0 %}
    
    <!-- Bulk Actions -->
    <div class="bulk-actions" id="bulkActions">
        <span style="color: var(--orange); font-weight: bold; margin-right: 20px;">
            <span id="selectedCount">0</span> selected
        </span>
        <button class="btn btn-secondary" onclick="selectAll()">select all</button>
        <button class="btn btn-secondary" onclick="selectNone()">select none</button>
        <button class="btn" onclick="restoreSelected()">‚ôªÔ∏è restore selected</button>
        <button class="btn" onclick="deleteSelected()" style="background: var(--red); color: white;">
            üóëÔ∏è delete permanently
        </button>
    </div>
    
    <!-- Selection Mode Toggle -->
    <div style="margin-bottom: 10px;">
        <label style="color: var(--gray); font-size: 12px; cursor: pointer;">
            <input type="checkbox" id="enableSelection" onchange="toggleSelectionMode()"> 
            enable multi-select mode
        </label>
    </div>
    
    <!-- Deleted Documents by Date -->
    {% for date, docs in deletion_groups.items %}
    <div class="deletion-group">
        <div class="group-header">
            <span class="group-date">{{ date|date:"d M Y" }}</span>
            <span class="group-count">{{ docs|length }} document{{ docs|length|pluralize }}</span>
        </div>
        
        {% for doc in docs %}
        <div class="deleted-item" data-doc-id="{{ doc.id }}">
            <input type="checkbox" 
                   class="item-checkbox" 
                   data-doc-id="{{ doc.id }}"
                   onchange="updateSelection()"
                   style="display: none;">
            
            <div class="item-info">
                {% if doc.thumbnail_path %}
                <img src="{{ doc.thumbnail_path.url }}" class="item-thumbnail" alt="">
                {% else %}
                <div class="item-thumbnail" style="display: flex; align-items: center; justify-content: center; background: var(--dark-gray);">
                    üìÑ
                </div>
                {% endif %}
                
                <div class="item-details">
                    <div class="item-name">{{ doc.original_filename|truncatechars:50 }}</div>
                    <div class="item-meta">
                        {{ doc.document_type }} ‚Ä¢ 
                        deleted {{ doc.deleted_at|timesince }} ago
                        {% if doc.deleted_by %}by {{ doc.deleted_by.username }}{% endif %}
                    </div>
                </div>
                
                <span class="item-countdown {% if doc.days_until_deletion <= 3 %}urgent{% endif %}">
                    {% if doc.days_until_deletion > 0 %}
                        {{ doc.days_until_deletion }} day{{ doc.days_until_deletion|pluralize }} left
                    {% else %}
                        will be deleted today!
                    {% endif %}
                </span>
            </div>
            
            <div class="item-actions">
                <button class="btn btn-secondary" onclick="restoreDocument('{{ doc.id }}')">
                    ‚ôªÔ∏è restore
                </button>
                <button class="btn btn-secondary" onclick="deleteDocument('{{ doc.id }}')" style="color: var(--red);">
                    üóëÔ∏è delete
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endfor %}
    
    {% else %}
    
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-icon">üóëÔ∏è</div>
        <h2 style="color: var(--white); margin-bottom: 10px;">recycle bin is empty</h2>
        <p>deleted documents will appear here</p>
        <p style="font-size: 11px; margin-top: 20px;">
            documents are kept for 30 days before permanent deletion
        </p>
    </div>
    
    {% endif %}
</div>

<script>
let selectionMode = false;
let selectedDocuments = new Set();

function toggleSelectionMode() {
    selectionMode = document.getElementById('enableSelection').checked;
    const checkboxes = document.querySelectorAll('.item-checkbox');
    const bulkActions = document.getElementById('bulkActions');
    
    if (selectionMode) {
        checkboxes.forEach(cb => cb.style.display = 'block');
        bulkActions.classList.add('show');
    } else {
        checkboxes.forEach(cb => {
            cb.style.display = 'none';
            cb.checked = false;
        });
        bulkActions.classList.remove('show');
        selectedDocuments.clear();
        updateSelectionUI();
    }
}

function updateSelection() {
    selectedDocuments.clear();
    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
    
    checkboxes.forEach(cb => {
        const docId = cb.dataset.docId;
        selectedDocuments.add(docId);
        cb.closest('.deleted-item').classList.add('selected');
    });
    
    document.querySelectorAll('.item-checkbox:not(:checked)').forEach(cb => {
        cb.closest('.deleted-item').classList.remove('selected');
    });
    
    updateSelectionUI();
}

function updateSelectionUI() {
    document.getElementById('selectedCount').textContent = selectedDocuments.size;
}

function selectAll() {
    document.querySelectorAll('.item-checkbox').forEach(cb => {
        cb.checked = true;
    });
    updateSelection();
}

function selectNone() {
    document.querySelectorAll('.item-checkbox').forEach(cb => {
        cb.checked = false;
    });
    updateSelection();
}

function restoreDocument(docId) {
    if (confirm('Restore this document?')) {
        restoreDocuments([docId]);
    }
}

function restoreSelected() {
    if (selectedDocuments.size === 0) {
        alert('No documents selected');
        return;
    }
    
    if (confirm(`Restore ${selectedDocuments.size} document(s)?`)) {
        restoreDocuments(Array.from(selectedDocuments));
    }
}

function restoreDocuments(docIds) {
    fetch('{% url "documents:restore" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            document_ids: docIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.restored_count} document(s) restored`);
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function deleteDocument(docId) {
    if (confirm('Permanently delete this document? This cannot be undone!')) {
        deleteDocuments([docId]);
    }
}

function deleteSelected() {
    if (selectedDocuments.size === 0) {
        alert('No documents selected');
        return;
    }
    
    if (confirm(`Permanently delete ${selectedDocuments.size} document(s)? This cannot be undone!`)) {
        deleteDocuments(Array.from(selectedDocuments));
    }
}

function deleteDocuments(docIds) {
    fetch('{% url "documents:permanent_delete" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            document_ids: docIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.deleted_count} document(s) permanently deleted`);
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function emptyRecycleBin() {
    if (confirm('Empty the entire recycle bin? All documents will be permanently deleted!')) {
        if (confirm('This action cannot be undone. Are you absolutely sure?')) {
            document.getElementById('emptyForm').submit();
        }
    }
}
</script>

<!-- Hidden form for empty action -->
<form id="emptyForm" method="post" action="{% url 'documents:empty_recycle_bin' %}" style="display: none;">
    {% csrf_token %}
</form>

{% endblock %}