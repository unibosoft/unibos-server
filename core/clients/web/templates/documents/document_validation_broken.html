{% extends 'web_ui/base.html' %}

{% block title %}community validation - earn carrots ü•ï{% endblock %}

{% block header_title %}unibos{% endblock %}
{% block module_name %}documents{% endblock %}

{% block extra_head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<style>
    /* Reset parent container styles */
    .content {
        padding: 0 !important;
        overflow: visible !important;
    }
    
    .validation-container {
        width: 100%;
        max-width: 100%;
        padding: 20px;
        box-sizing: border-box;
        overflow-x: hidden;
        position: relative;
    }
    
    .validation-header {
        background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
        border: 2px solid var(--orange);
        border-radius: 10px;
        padding: 30px;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
        max-width: 100%;
    }
    
    .validation-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,140,0,0.1) 0%, transparent 70%);
        animation: pulse 4s ease-in-out infinite;
    }
    
    .carrot-counter {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255,140,0,0.2);
        border: 2px solid var(--orange);
        border-radius: 20px;
        padding: 10px 20px;
        font-size: 24px;
        font-weight: bold;
        color: var(--orange);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .validation-grid {
        display: flex !important;
        gap: 20px;
        margin-top: 20px;
        height: calc(100vh - 250px);
        min-height: 600px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        position: relative;
        flex-direction: row !important;
        align-items: stretch;
    }
    
    .validation-queue {
        background: var(--bg-dark);
        border: 1px solid var(--dark-gray);
        border-radius: 10px;
        padding: 15px;
        overflow-y: auto;
        height: 100%;
        max-height: calc(100vh - 280px);
        width: 250px !important;
        min-width: 250px !important;
        max-width: 250px !important;
        flex: 0 0 250px !important;
        flex-shrink: 0 !important;
        flex-grow: 0 !important;
        box-sizing: border-box;
    }
    
    .validation-queue::-webkit-scrollbar {
        width: 8px;
    }
    
    .validation-queue::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.3);
        border-radius: 4px;
    }
    
    .validation-queue::-webkit-scrollbar-thumb {
        background: var(--orange);
        border-radius: 4px;
        opacity: 0.7;
    }
    
    .validation-queue::-webkit-scrollbar-thumb:hover {
        opacity: 1;
    }
    
    .validation-stats::-webkit-scrollbar {
        width: 8px;
    }
    
    .validation-stats::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.3);
        border-radius: 4px;
    }
    
    .validation-stats::-webkit-scrollbar-thumb {
        background: var(--orange);
        border-radius: 4px;
        opacity: 0.7;
    }
    
    .validation-stats::-webkit-scrollbar-thumb:hover {
        opacity: 1;
    }
    
    .validation-main {
        background: #000;
        border: 2px solid var(--orange);
        border-radius: 10px;
        padding: 20px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100%;
        flex: 1;
        min-width: 0;
    }
    
    .validation-stats {
        background: var(--bg-dark);
        border: 1px solid var(--dark-gray);
        border-radius: 10px;
        padding: 20px;
        overflow-y: auto;
        height: 100%;
        max-height: calc(100vh - 280px);
        width: 250px !important;
        min-width: 250px !important;
        max-width: 250px !important;
        flex: 0 0 250px !important;
        flex-shrink: 0 !important;
        flex-grow: 0 !important;
        box-sizing: border-box;
    }
    
    .receipt-preview {
        background: #fff;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        color: #000;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        min-height: 400px;
        max-height: 500px;
        overflow-y: auto;
        flex-shrink: 0;
    }
    
    .validation-form {
        background: rgba(0,255,0,0.05);
        border: 1px solid var(--green);
        border-radius: 5px;
        padding: 15px;
        margin-top: auto;
        flex-shrink: 0;
        overflow-y: auto;
        max-height: 300px;
    }
    
    .field-validation {
        display: grid;
        grid-template-columns: 150px 1fr 100px;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background: rgba(0,0,0,0.5);
        border-radius: 5px;
    }
    
    .field-label {
        color: var(--cyan);
        font-weight: bold;
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 1px;
    }
    
    .field-value {
        background: #000;
        border: 1px solid var(--dark-gray);
        border-radius: 3px;
        padding: 8px;
        color: var(--yellow);
        font-family: 'JetBrains Mono', monospace;
    }
    
    .field-value.editable {
        border-color: var(--orange);
        cursor: text;
    }
    
    .field-value.editable:focus {
        outline: none;
        border-color: var(--cyan);
        box-shadow: 0 0 10px rgba(0,255,255,0.3);
    }
    
    .validation-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }
    
    .btn-validate {
        background: linear-gradient(45deg, #00FF00, #00CC00);
        color: #000;
        border: none;
        padding: 12px 30px;
        border-radius: 5px;
        font-weight: bold;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-validate:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0,255,0,0.4);
    }
    
    .btn-reject {
        background: linear-gradient(45deg, #FF0000, #CC0000);
        color: #fff;
    }
    
    .btn-skip {
        background: linear-gradient(45deg, #666, #444);
        color: #fff;
    }
    
    .queue-item {
        background: rgba(255,140,0,0.1);
        border: 1px solid var(--orange);
        border-radius: 5px;
        padding: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.3s;
        display: block;
        width: calc(100% - 2px) !important;
        max-width: 220px !important;
        box-sizing: border-box;
        overflow: hidden;
    }
    
    .queue-item:hover {
        background: rgba(255,140,0,0.2);
        transform: translateX(5px);
    }
    
    .queue-item.active {
        background: rgba(255,140,0,0.3);
        border-width: 2px;
    }
    
    .stat-card {
        background: rgba(0,255,255,0.05);
        border: 1px solid var(--cyan);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: var(--orange);
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: var(--gray);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .accuracy-meter {
        width: 100%;
        height: 20px;
        background: #000;
        border: 1px solid var(--dark-gray);
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
    }
    
    .accuracy-fill {
        height: 100%;
        background: linear-gradient(90deg, #FF0000, #FFA500, #00FF00);
        transition: width 0.5s ease;
    }
    
    .expert-badge {
        background: linear-gradient(45deg, #FFD700, #FFA500);
        color: #000;
        padding: 5px 10px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 10px;
        text-transform: uppercase;
        display: inline-block;
        margin-top: 10px;
        animation: shine 2s infinite;
    }
    
    @keyframes shine {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    .loading-shimmer {
        background: linear-gradient(90deg, transparent 0%, rgba(255,140,0,0.2) 50%, transparent 100%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
</style>

<div class="validation-container">
    <!-- Header with Carrot Counter -->
    <div class="validation-header">
        <div class="carrot-counter">
            <span>ü•ï</span>
            <span id="carrotCount">{{ profile.total_points }}</span>
        </div>
        
        <h1 style="color: var(--orange); font-size: 36px; margin: 0; text-transform: lowercase; letter-spacing: 3px;">
            community validation hub
        </h1>
        <p style="color: var(--cyan); margin-top: 10px; font-size: 14px; text-transform: lowercase;">
            help validate receipts and earn carrots! each validation: +3 ü•ï | accurate validation: +5 ü•ï
        </p>
        
        {% if profile.accuracy_score >= 90 %}
        <span class="expert-badge">‚≠ê expert validator - 2x carrots</span>
        {% endif %}
    </div>
    
    <div class="validation-grid">
        <!-- Queue Section -->
        <div class="validation-queue">
            <h3 style="color: var(--orange); text-transform: lowercase; letter-spacing: 2px; margin-bottom: 20px;">
                validation queue ({{ total_pending }} receipts)
            </h3>
            
            {% if pending_validations %}
                {% for receipt in pending_validations %}
                <div class="queue-item {% if forloop.first %}active{% endif %}" 
                     data-receipt-id="{{ receipt.id }}"
                     onclick="loadReceipt('{{ receipt.id }}')">
                    <div style="display: flex; gap: 8px; align-items: flex-start; width: 100%;">
                    <!-- Receipt thumbnail - constrained size -->
                    {% if receipt.thumbnail_path %}
                    <div style="width: 40px !important; min-width: 40px !important; max-width: 40px !important; height: 40px !important; overflow: hidden; border-radius: 3px; border: 1px solid var(--orange); flex-shrink: 0;">
                        <img src="{{ receipt.thumbnail_path.url }}" 
                             style="width: 100%; height: 100%; object-fit: cover; object-position: top;"
                             onerror="this.parentElement.innerHTML='<div style=\"width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(255,140,0,0.1);font-size:16px;\">üìÑ</div>'">
                    </div>
                    {% else %}
                    <div style="width: 40px !important; min-width: 40px !important; max-width: 40px !important; height: 40px !important; background: rgba(255,140,0,0.1); border: 1px solid var(--orange); border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;">
                        üìÑ
                    </div>
                    {% endif %}
                        
                    <div style="flex: 1; min-width: 0; max-width: calc(100% - 50px); overflow: hidden;">
                        <div style="font-weight: bold; color: var(--cyan); font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px;">
                            {{ receipt.store_name|default:"unknown store"|lower }}
                        </div>
                        <div style="font-size: 9px; color: var(--gray);">
                            {{ receipt.uploaded_at|date:"M d, H:i" }}
                        </div>
                        <div style="font-size: 10px; color: var(--yellow); margin-top: 2px;">
                            ‚Ç∫{{ receipt.total_amount|default:"0.00"|floatformat:2 }}
                        </div>
                    </div>
                    </div>
                    
                    {% if receipt.processing_status == 'pending' %}
                    <div style="margin-top: 5px; padding: 2px 5px; background: rgba(255,255,0,0.2); border: 1px solid yellow; border-radius: 3px; font-size: 9px; color: yellow; text-align: center;">
                        processing
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; color: var(--gray); padding: 40px 0;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
                    <div style="text-transform: lowercase;">no receipts to validate</div>
                    <div style="font-size: 11px; margin-top: 10px; text-transform: lowercase;">check back later!</div>
                </div>
            {% endif %}
        </div>
        
        <!-- Main Validation Area -->
        <div class="validation-main">
            {% if current_receipt %}
            <h3 style="color: var(--cyan); text-transform: lowercase; letter-spacing: 2px; margin-bottom: 20px;">
                validate receipt data
            </h3>
            
            <!-- Receipt Preview with Image -->
            <div class="receipt-preview" style="display: flex; gap: 15px;">
                <!-- Receipt Image with zoom on hover -->
                {% if current_receipt.file_path %}
                <div style="width: 250px; flex-shrink: 0;">
                    <img src="{{ current_receipt.file_path.url }}?v={{ now|date:'U' }}" 
                         alt="Receipt image" 
                         id="receiptImage"
                         style="width: 100%; max-height: 450px; object-fit: contain; border: 1px solid #ddd; border-radius: 5px; cursor: zoom-in; transition: transform 0.3s;"
                         onmousemove="zoomImage(event)"
                         onmouseleave="resetZoom()"
                         onerror="console.error('Failed to load image:', this.src);">
                    <div style="margin-top: 5px; font-size: 10px; color: #666; text-align: center;">
                        {{ current_receipt.original_filename }} ‚Ä¢ hover to zoom
                    </div>
                </div>
                {% elif current_receipt.thumbnail_path %}
                <div style="width: 250px; flex-shrink: 0;">
                    <img src="{{ current_receipt.thumbnail_path.url }}?v={{ now|date:'U' }}" 
                         alt="Receipt thumbnail" 
                         style="width: 100%; max-height: 450px; object-fit: contain; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                {% else %}
                <div style="width: 250px; background: #f0f0f0; padding: 20px; text-align: center; border-radius: 5px; min-height: 350px; display: flex; flex-direction: column; justify-content: center; flex-shrink: 0;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìÑ</div>
                    <div style="color: #666; font-size: 12px;">no image available</div>
                </div>
                {% endif %}
                
                <!-- OCR Text -->
                <div style="flex: 1; background: #000; border: 1px solid #333; padding: 15px; border-radius: 5px; overflow-y: auto; max-height: 450px; min-width: 0;">
                    <div style="color: var(--green); font-size: 10px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">tesseract ocr raw text:</div>
                    <pre style="font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.5; color: var(--cyan); white-space: pre-wrap; word-wrap: break-word;">{{ current_receipt.ocr_text|default:"[no ocr text available]" }}</pre>
                    
                    {% if current_receipt.ocr_confidence %}
                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #333;">
                        <span style="color: var(--gray); font-size: 10px;">confidence: </span>
                        <span style="color: {% if current_receipt.ocr_confidence > 80 %}var(--green){% elif current_receipt.ocr_confidence > 60 %}var(--orange){% else %}var(--red){% endif %}; font-weight: bold;">
                            {{ current_receipt.ocr_confidence|floatformat:0 }}%
                        </span>
                        <span style="color: #555; font-size: 9px; margin-left: 15px;">
                            {{ current_receipt.ocr_text|length }} chars ‚Ä¢ {{ current_receipt.processing_status }}
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Validation Form -->
            <div class="validation-form">
                <form id="validationForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="receipt_id" value="{{ current_receipt.id }}">
                    
                    <div class="field-validation">
                        <span class="field-label">Store Name:</span>
                        <input type="text" class="field-value editable" 
                               name="store_name" 
                               value="{{ current_receipt.parsed_receipt.store_name|default:'' }}"
                               placeholder="Enter store name">
                        <span style="color: var(--green);">+3 ü•ï</span>
                    </div>
                    
                    <div class="field-validation">
                        <span class="field-label">Date:</span>
                        <input type="date" class="field-value editable" 
                               name="date"
                               value="{{ current_receipt.parsed_receipt.transaction_date|date:'Y-m-d'|default:'' }}">
                        <span style="color: var(--green);">+3 ü•ï</span>
                    </div>
                    
                    <div class="field-validation">
                        <span class="field-label">Total Amount:</span>
                        <input type="number" step="0.01" class="field-value editable" 
                               name="total_amount"
                               value="{{ current_receipt.parsed_receipt.total_amount|default:'' }}"
                               placeholder="0.00">
                        <span style="color: var(--green);">+5 ü•ï</span>
                    </div>
                    
                    <div class="field-validation">
                        <span class="field-label">Tax Amount:</span>
                        <input type="number" step="0.01" class="field-value editable" 
                               name="tax_amount"
                               value="{{ current_receipt.parsed_receipt.tax_amount|default:'' }}"
                               placeholder="0.00">
                        <span style="color: var(--green);">+2 ü•ï</span>
                    </div>
                    
                    <div class="field-validation">
                        <span class="field-label">Receipt #:</span>
                        <input type="text" class="field-value editable" 
                               name="receipt_number"
                               value="{{ current_receipt.parsed_receipt.receipt_number|default:'' }}"
                               placeholder="Receipt number">
                        <span style="color: var(--green);">+2 ü•ï</span>
                    </div>
                </form>
                
                <div class="validation-buttons">
                    <button class="btn-validate btn-reject" onclick="rejectReceipt()">
                        ‚ùå Reject
                    </button>
                    <button class="btn-validate btn-skip" onclick="skipReceipt()">
                        ‚è≠Ô∏è Skip
                    </button>
                    <button class="btn-validate" onclick="validateReceipt()">
                        ‚úÖ Validate (+{{ potential_carrots }} ü•ï)
                    </button>
                </div>
            </div>
            {% else %}
            <div style="text-align: center; padding: 60px 0; color: var(--gray);">
                <div style="font-size: 64px; margin-bottom: 20px;">ü•ï</div>
                <h3 style="color: var(--orange);">Ready to Validate!</h3>
                <p>Select a receipt from the queue to start earning carrots</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Stats Section -->
        <div class="validation-stats">
            <h3 style="color: var(--orange); text-transform: lowercase; letter-spacing: 2px; margin-bottom: 20px;">
                your stats
            </h3>
            
            <div class="stat-card">
                <div class="stat-value">{{ stats.validations_today }}</div>
                <div class="stat-label">validations today</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{ stats.total_validations }}</div>
                <div class="stat-label">total validations</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{ stats.accuracy }}%</div>
                <div class="stat-label">accuracy score</div>
                <div class="accuracy-meter">
                    <div class="accuracy-fill" style="width: {{ stats.accuracy }}%"></div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{ stats.carrots_earned_today }}</div>
                <div class="stat-label">carrots today</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">#{{ stats.rank }}</div>
                <div class="stat-label">global rank</div>
            </div>
            
            {% if stats.is_expert %}
            <div style="text-align: center; margin-top: 20px;">
                <span class="expert-badge">‚≠ê EXPERT VALIDATOR</span>
                <p style="color: var(--green); font-size: 11px; margin-top: 10px;">
                    2X CARROT MULTIPLIER ACTIVE!
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function loadReceipt(receiptId) {
        // Update active queue item
        document.querySelectorAll('.queue-item').forEach(item => {
            item.classList.remove('active');
        });
        event.currentTarget.classList.add('active');
        
        // Load receipt data via AJAX
        fetch(`/documents/api/receipt/${receiptId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the validation form with new receipt data
                    updateValidationForm(data.receipt);
                } else {
                    console.error('Failed to load receipt:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading receipt:', error);
            });
    }
    
    function updateValidationForm(receipt) {
        // Update OCR text display
        const ocrTextEl = document.querySelector('.receipt-preview pre');
        if (ocrTextEl) {
            ocrTextEl.textContent = receipt.ocr_text || 'No OCR text available';
        }
        
        // Update image if available
        const imageContainer = document.querySelector('.receipt-preview > div:first-child');
        if (imageContainer && receipt.thumbnail_url) {
            imageContainer.innerHTML = `
                <img src="${receipt.thumbnail_url}" 
                     alt="Receipt image" 
                     style="width: 100%; max-height: 400px; object-fit: contain; border: 1px solid #ddd; border-radius: 5px;">
            `;
        } else if (imageContainer && receipt.file_url) {
            imageContainer.innerHTML = `
                <div style="background: #f0f0f0; padding: 20px; text-align: center; border-radius: 5px; height: 400px; display: flex; flex-direction: column; justify-content: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìÑ</div>
                    <div style="color: #666; font-size: 12px;">${receipt.original_filename || 'receipt image'}</div>
                    <a href="${receipt.file_url}" target="_blank" 
                       style="color: var(--orange); text-decoration: none; font-size: 11px; margin-top: 10px; display: block;">
                       view full image ‚Üí
                    </a>
                </div>
            `;
        }
        
        // Update confidence if available
        const confidenceEl = document.querySelector('.receipt-preview .ocr-confidence');
        if (confidenceEl && receipt.ocr_confidence) {
            let color = 'red';
            if (receipt.ocr_confidence > 80) color = 'green';
            else if (receipt.ocr_confidence > 60) color = 'orange';
            
            confidenceEl.innerHTML = `
                <span style="color: #666; font-size: 10px;">ocr confidence: </span>
                <span style="color: ${color}; font-weight: bold;">
                    ${Math.round(receipt.ocr_confidence)}%
                </span>
            `;
        }
        
        // Update form fields with parsed data
        if (receipt.parsed_data) {
            const form = document.getElementById('validationForm');
            if (form) {
                // Update receipt ID
                form.querySelector('input[name="receipt_id"]').value = receipt.id;
                
                // Update form fields
                if (receipt.parsed_data.store_name) {
                    form.querySelector('input[name="store_name"]').value = receipt.parsed_data.store_name;
                }
                if (receipt.parsed_data.transaction_date) {
                    form.querySelector('input[name="date"]').value = receipt.parsed_data.transaction_date.split('T')[0];
                }
                if (receipt.parsed_data.total_amount) {
                    form.querySelector('input[name="total_amount"]').value = receipt.parsed_data.total_amount;
                }
                if (receipt.parsed_data.tax_amount) {
                    form.querySelector('input[name="tax_amount"]').value = receipt.parsed_data.tax_amount;
                }
                if (receipt.parsed_data.receipt_number) {
                    form.querySelector('input[name="receipt_number"]').value = receipt.parsed_data.receipt_number;
                }
            }
        }
    }
    
    function validateReceipt() {
        const form = document.getElementById('validationForm');
        const formData = new FormData(form);
        
        fetch('/documents/document-validation/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show carrot animation
                showCarrotAnimation(data.carrots_earned);
                // Update carrot counter
                updateCarrotCount(data.new_total);
                // Load next receipt
                if (data.next_receipt_id) {
                    loadReceipt(data.next_receipt_id);
                } else {
                    location.reload();
                }
            }
        });
    }
    
    function rejectReceipt() {
        if (confirm('Are you sure you want to reject this receipt?')) {
            // Handle rejection
            skipReceipt();
        }
    }
    
    function skipReceipt() {
        // Move to next receipt
        const nextItem = document.querySelector('.queue-item.active').nextElementSibling;
        if (nextItem) {
            nextItem.click();
        } else {
            location.reload();
        }
    }
    
    function showCarrotAnimation(carrots) {
        // Create floating carrot animation
        const animation = document.createElement('div');
        animation.innerHTML = `+${carrots} ü•ï`;
        animation.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #FFA500;
            z-index: 9999;
            animation: floatUp 2s ease-out forwards;
        `;
        document.body.appendChild(animation);
        
        setTimeout(() => animation.remove(), 2000);
    }
    
    function updateCarrotCount(newTotal) {
        const counter = document.getElementById('carrotCount');
        counter.textContent = newTotal;
        counter.style.animation = 'pulse 0.5s';
        setTimeout(() => counter.style.animation = '', 500);
    }
    
    // Zoom functions for receipt image
    function zoomImage(event) {
        const img = event.target;
        const rect = img.getBoundingClientRect();
        const x = ((event.clientX - rect.left) / rect.width) * 100;
        const y = ((event.clientY - rect.top) / rect.height) * 100;
        
        img.style.transformOrigin = `${x}% ${y}%`;
        img.style.transform = 'scale(2)';
        img.style.cursor = 'zoom-out';
    }
    
    function resetZoom() {
        const img = document.getElementById('receiptImage');
        if (img) {
            img.style.transform = 'scale(1)';
            img.style.cursor = 'zoom-in';
        }
    }
    
    // Add floating animation CSS
    const style = document.createElement('style');
    style.textContent = `
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -200%);
            }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}